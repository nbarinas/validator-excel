<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina - AZ Marketing</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* SCROLL FIX */
        body {
            height: auto !important;
            min-height: 100vh;
            overflow-y: auto !important;
        }

        .payroll-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            color: white;
            padding-bottom: 50px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table th {
            background: rgba(15, 23, 42, 0.8);
            color: #cbd5e1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e293b;
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #334155;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            color: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        /* Print Styles */
        .print-view {
            background: white;
            color: black;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .print-view,
            .print-view * {
                visibility: visible;
            }

            .print-view {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }
        }
    </style>
</head>

<body>
    <div class="payroll-container">
        <header class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="/" style="color: white; text-decoration: none;"><i class="fas fa-arrow-left"></i> Volver</a>
                <h1><i class="fas fa-money-bill-wave"></i> Gestión de Nómina</h1>
            </div>
            <div id="rolDisplay"></div>
        </header>

        <!-- ADMIN VIEW -->
        <div id="adminView" style="display: none;">

            <!-- TOP ACTIONS: Global Print -->
            <div style="margin-bottom: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="openLoansModal()"
                    style="background: #eab308; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    <i class="fas fa-hand-holding-usd"></i> Gestión de Préstamos
                </button>
                <button onclick="openGlobalAccountModal()"
                    style="background: #8b5cf6; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    <i class="fas fa-print"></i> Consultar Pagos / Imprimir Cuenta Global
                </button>
            </div>

            <!-- CREATION CARD -->
            <div class="card" id="creationCard"
                style="margin-bottom: 2rem; border-left: 4px solid var(--primary-color);">
                <h3><i class="fas fa-plus-square"></i> Registrar Nueva Nómina</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: end;">
                    <div class="form-group">
                        <label>Nombre del Estudio / Concepto</label>
                        <input type="text" id="pName" placeholder="Ej: Proyecto Ascensores Enero">
                    </div>
                    <div class="form-group">
                        <label>Código Estudio</label>
                        <input type="text" id="pCode" placeholder="Ej: 2548">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:10px;">
                    <div class="form-group">
                        <label>Tipo de Estudio</label>
                        <select id="pType" class="form-input" onchange="updateDefaultRates()">
                            <option value="ascensor">Ascensor</option>
                            <option value="in_home">In Home</option>
                            <option value="tdc">Test de Compra (TDC)</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Asignar Supervisores (Visible para)</label>
                        <div id="supervisorList"
                            style="max-height:100px; overflow-y:auto; background:rgba(30,41,59,0.5); border:1px solid #475569; padding:5px; border-radius:4px;">
                            <div style="color:#aaa; font-size:0.8rem; padding:5px;">Cargando...</div>
                        </div>
                    </div>
                    <div class="form-group"></div>
                </div>

                <!-- DATES ROW -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:10px;">
                    <div class="form-group">
                        <label>Fecha Inicio</label>
                        <input type="date" id="pStartDate">
                    </div>
                    <div class="form-group">
                        <label>Fecha Cierre</label>
                        <input type="date" id="pEndDate">
                    </div>
                </div>

                <!-- CONCEPTS SECTION -->
                <div style="margin-top: 20px;">
                    <label style="display:block; margin-bottom:10px;">Conceptos de Pago (Items)</label>

                    <div id="conceptsContainer">
                        <!-- Dynamic Rows -->
                    </div>

                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="addConceptRow()"
                            style="background:rgba(255,255,255,0.1); color:white; border:1px dashed #aaa; padding:8px; border-radius:6px; cursor:pointer; flex:1;">
                            <i class="fas fa-plus"></i> Agregar Item
                        </button>
                    </div>
                </div>

                <div style="margin-top:20px; display:flex; justify-content:flex-end;">
                    <button class="btn-submit" onclick="createLiquidacion()" style="margin-bottom: 0px; height: 42px;">
                        <i class="fas fa-save"></i> Crear Nómina
                    </button>
                </div>
            </div>

            <!-- Autocomplete Styles -->
            <style>
                .autocomplete-items {
                    position: absolute;
                    border: 1px solid #d4d4d4;
                    border-bottom: none;
                    border-top: none;
                    z-index: 99;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background-color: #1e293b;
                    max-height: 150px;
                    overflow-y: auto;
                }

                .autocomplete-items div {
                    padding: 10px;
                    cursor: pointer;
                    background-color: #1e293b;
                    border-bottom: 1px solid #d4d4d4;
                    color: white;
                }

                .autocomplete-items div:hover {
                    background-color: #334155;
                }

                .autocomplete-active {
                    background-color: #3b82f6 !important;
                }
            </style>

            <!-- LIST CARD -->
            <div class="card" id="listCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <input type="checkbox" id="selectAllPeriods" onchange="toggleSelectAll(this)"
                            style="width: 20px; height: 20px; cursor: pointer;" title="Seleccionar Todos">
                        <h3 style="margin:0;">Historial de Nóminas</h3>
                    </div>
                    <div id="bulkActions" style="display: none; gap: 10px;">
                        <button onclick="exportBulkExcel()"
                            style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button onclick="exportBulkPDF()"
                            style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>
                <div id="periodsList"></div>
            </div>

            <!-- DETAILS CARD (Initially Hidden) -->
            <div class="card" id="periodDetailsCard"
                style="margin-top: 2rem; display: none; border-top: 4px solid #f59e0b;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h3 id="detailsTitle" style="margin:0;">Detalle</h3>
                        <p id="detailsSubtitle" style="color:#aaa; font-size:0.9rem; margin:0;"></p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openManualModal()"
                            style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-user-plus"></i> Agregar Persona
                        </button>

                        <button id="editPeriodBtn" onclick="openConceptManager()"
                            style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;">
                            <i class="fas fa-edit"></i> Editar Nómina
                        </button>

                        <div style="border-left: 1px solid #475569; margin: 0 5px;"></div>

                        <button onclick="exportToExcel()"
                            style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;"
                            title="Descargar Excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button onclick="exportToPDF()"
                            style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;"
                            title="Imprimir PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button onclick="closeDetails()"
                            style="background: transparent; color: white; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-arrow-left"></i> Volver a Lista
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Efectivas</th>
                                <th>Censos</th>
                                <th>Total Pagar</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="periodDetailsBody"></tbody>
                        <tfoot id="periodDetailsFoot" style="background: rgba(15, 23, 42, 0.8); font-weight: bold;">
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- AGENT VIEW -->
        <div id="agentView" style="display: none;">
            <div class="card">
                <h3>Mis Pagos Disponibles</h3>
                <div id="myPaymentsList"></div>
            </div>
        </div>

        <!-- Manual Entry Modal -->
        <div id="manualModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeManualModal()">&times;</span>
                <h3>Registrar Actividad</h3>
                <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 1rem;">Seleccione quién trabajó y qué
                    cantidades hizo.</p>

                <div class="form-group">
                    <label>Colaborador</label>
                    <input list="manualUserList" id="manualUserInput" class="form-input"
                        placeholder="Escriba para buscar..." onchange="resolveManualUser()">
                    <datalist id="manualUserList"></datalist>
                    <input type="hidden" id="manualUserId">
                </div>

                <div
                    style="background:rgba(0,0,0,0.2); padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #334155;">
                    <div style="display: grid; grid-template-columns: 1.5fr 2fr 1fr auto; gap: 5px; align-items: end;">
                        <div class="form-group">
                            <label style="font-size:0.8rem;">Fecha</label>
                            <input type="date" id="newItemDate" class="form-input" style="padding:5px;">
                        </div>
                        <div class="form-group">
                            <label style="font-size:0.8rem;">Concepto</label>
                            <select id="newItemConcept" class="form-input" style="padding:5px;"></select>
                        </div>
                        <div class="form-group">
                            <label style="font-size:0.8rem;">Cant.</label>
                            <input type="number" id="newItemQty" class="form-input" style="padding:5px;" value="1">
                        </div>
                        <button onclick="addManualItem()"
                            style="background:#22c55e; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; height:36px; margin-bottom:0;"><i
                                class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div style="max-height:200px; overflow:auto; margin-bottom:15px; border:1px solid #334155;">
                    <table style="width:100%; font-size:0.9rem; border-collapse:collapse;">
                        <thead style="background:#1e293b; position:sticky; top:0;">
                            <tr>
                                <th style="padding:5px; text-align:left;">Fecha</th>
                                <th style="padding:5px; text-align:left;">Concepto</th>
                                <th style="padding:5px; text-align:center;">Cant.</th>
                                <th style="padding:5px; text-align:right;">Total</th>
                                <th style="padding:5px;"></th>
                            </tr>
                        </thead>
                        <tbody id="manualItemsBody"></tbody>
                    </table>
                </div>

                <div style="text-align:right; font-weight:bold; margin-bottom:15px;">
                    Total: <span id="manualTotalDisplay" style="color:#4ade80;">$0</span>
                </div>

                <button class="btn-submit" onclick="saveManualRecord()">Guardar Registro</button>
            </div>
        </div>

        <!-- Global Print Modal -->
        <div id="globalPrintModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeGlobalPrintModal()">&times;</span>
                <h3>Consultar Pagos / Cuenta Global</h3>
                <p style="color: #94a3b8; margin-bottom: 20px;">Seleccione un colaborador para ver todos sus pagos
                    pendientes y generar la cuenta de cobro unificada.</p>

                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input list="globalUserList" id="globalUserParams" class="form-input" style="flex:1;"
                        placeholder="Buscar colaborador..." onchange="resolveGlobalUser()">
                    <datalist id="globalUserList"></datalist>
                    <input type="hidden" id="globalUserId">

                    <button onclick="loadGlobalRecords()"
                        style="background:#3b82f6; color:white; border:none; padding:0 20px; border-radius:6px;">Consultar</button>
                </div>

                <div id="globalResultsArea" style="display:none;">
                    <div style="background: rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Total Efectivas:</span>
                            <span id="globalSumEff" style="font-weight:bold;">0</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Total Censos:</span>
                            <span id="globalSumCen" style="font-weight:bold;">0</span>
                        </div>
                        <div
                            style="display:flex; justify-content:space-between; font-size:1.2rem; border-top:1px solid #444; padding-top:10px;">
                            <span>GRAN TOTAL A PAGAR:</span>
                            <span id="globalSumTotal" style="color:#4ade80; font-weight:bold;">$0</span>
                        </div>
                    </div>

                    <div
                        style="height:200px; overflow:auto; margin-bottom:20px; border:1px solid #333; border-radius:6px;">
                        <table class="data-table" style="font-size:0.9rem;">
                            <thead>
                                <tr>
                                    <th>Estudio</th>
                                    <th>Detalle</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="globalTableBody"></tbody>
                        </table>
                    </div>

                    <button onclick="printGlobal()" class="btn-submit" style="background:#8b5cf6;"><i
                            class="fas fa-print"></i> Imprimir Cuenta de Cobro Global</button>
                </div>
            </div>
        </div>

    </div>

    <!-- PRINT TEMPLATE -->
    <div id="printArea" class="print-view">
        <table style="width: 100%; margin-bottom: 20px;">
            <tr>
                <td style="width: 50%; vertical-align: top;">
                    <!-- Logo Placeholder -->
                    <div style="font-weight:bold; font-size:1.5rem; color:#444;">AZ MARKETING</div>
                    <p style="margin:5px 0;">NIT: 900.123.456-7</p>
                </td>
                <td style="width: 50%; text-align: right; vertical-align: top;">
                    <h1 style="margin: 0;">CUENTA DE COBRO</h1>
                    <h3 id="printPeriodName" style="margin: 5px 0;"></h3>
                    <p id="printDate"></p>
                </td>
            </tr>
        </table>

        <div style="border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 15px 0; margin-bottom: 30px;">
            <table style="width: 100%;">
                <tr>
                    <td><strong>NOMBRE:</strong> <span id="printAgentName"></span></td>
                    <td><strong>CC:</strong> <span id="printAgentCC"></span></td>
                </tr>
                <tr>
                    <td colspan="2"><strong>CUENTA:</strong> <span id="printAgentBank"></span></td>
                </tr>
            </table>
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px;" border="1" cellpadding="8">
            <thead>
                <tr style="background: #f1f5f9;">
                    <th>Concepto / Actividad</th>
                    <th style="text-align:center;">Cantidad</th>
                    <th style="text-align:right;">Valor Unitario</th>
                    <th style="text-align:right;">Total</th>
                </tr>
            </thead>
            <tbody id="printDetailsBody">
                <!-- Rows -->
            </tbody>
            <tfoot>
                <tr style="background: #f1f5f9; font-weight: bold;">
                    <td colspan="3" style="text-align: right;">NETO A PAGAR:</td>
                    <td style="text-align:right;" id="printTotal"></td>
                </tr>
            </tfoot>
        </table>

        <div style="margin-top: 80px; display: flex; justify-content: space-between;">
            <div style="border-top: 1px solid black; width: 40%; text-align: center; padding-top: 5px;">
                Firma Beneficiario
            </div>
            <div style="border-top: 1px solid black; width: 40%; text-align: center; padding-top: 5px;">
                Aprobado AZ Marketing
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        let currentUser = null;
        let pRates = { census: 5000, effective: 10000 };
        let currentLiquidacionId = null;
        let currentPeriodUserIds = new Set();
        let globalRecordsCache = [];
        let globalSelectedUser = null;

        function findMatchingConcept(d, concepts) {
            let cid = d.concept_id;
            // Helper for normalization
            const norm = (s) => (s || '').toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

            // 1. ID Match
            const byId = concepts.find(c => c.id == cid);
            if (byId) return byId;

            // 2. Precise Name Match
            const dNameRaw = (d.concept || '').trim().toLowerCase();
            let found = concepts.find(c => c.name.trim().toLowerCase() === dNameRaw);
            if (found) return found;

            // 3. Aggressive Normalization + Plural
            if (d.concept) {
                const dNameNorm = norm(d.concept);
                found = concepts.find(c => norm(c.name) === dNameNorm);
                if (found) return found;

                // Plurals
                found = concepts.find(c => {
                    const cNorm = norm(c.name);
                    return cNorm === dNameNorm + 's' || cNorm === dNameNorm + 'es' ||
                        dNameNorm === cNorm + 's' || dNameNorm === cNorm + 'es';
                });
                if (found) return found;
            }

            return null;
        }

        async function init() {
            try {
                const res = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
                currentUser = await res.json();

                document.getElementById('rolDisplay').textContent = `Usuario: ${currentUser.username} (${currentUser.role})`;

                if (['superuser', 'coordinator', 'supervisor'].includes(currentUser.role)) {
                    document.getElementById('adminView').style.display = 'block';
                    loadPeriods();
                    loadUsersForDropdown();
                } else {
                    document.getElementById('agentView').style.display = 'block';
                    loadMyPayments();
                }

                // Default Dates
                const today = new Date();
                document.getElementById('pEndDate').valueAsDate = today;
                document.getElementById('pStartDate').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);

            } catch (e) { console.error(e); }
        }

        async function loadUsersForDropdown() {
            // Fetch ALL users (no filters) to allow user to decide who to add
            const uRes = await fetch('/users', { headers: { 'Authorization': 'Bearer ' + token } });
            const uList = await uRes.json();
            window.allUsersMap = {};

            const manualList = document.getElementById('manualUserList');
            if (manualList) manualList.innerHTML = '';

            const globalList = document.getElementById('globalUserList');
            if (globalList) globalList.innerHTML = '';

            const sorted = uList.sort((a, b) => (a.full_name || a.username).localeCompare(b.full_name || b.username));

            sorted.forEach(u => {
                window.allUsersMap[u.id] = u;

                // FILTER: Do not show 'auxiliar' role in the payroll addition list
                const r = (u.role || '').toLowerCase().trim();
                if (r === 'auxiliar') return;

                // Add to manual datalist
                let opt = document.createElement('option');
                opt.value = `${u.full_name || u.username} (${u.username})`; // Value shown

                if (manualList) manualList.appendChild(opt);

                // Add to Global Dropdown
                if (globalList) {
                    let opt2 = opt.cloneNode(true);
                    globalList.appendChild(opt2);
                }
            });
        }

        // --- GLOBAL PRINT LOGIC ---
        async function openGlobalPrintModal() {
            document.getElementById('globalPrintModal').style.display = 'block';
            document.getElementById('globalResultsArea').style.display = 'none';
            // Clear input
            document.getElementById('globalUserParams').value = '';
            document.getElementById('globalUserId').value = '';
        }

        async function loadSupervisorsForAssignment() {
            const container = document.getElementById('supervisorList');
            if (!container) return;

            try {
                const res = await fetch('/payroll/active-users', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    const users = await res.json();
                    container.innerHTML = '';

                    // Filter? Maybe show all for flexibility
                    const sorted = users.sort((a, b) => (a.full_name || a.username).localeCompare(b.full_name || b.username));

                    sorted.forEach(u => {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.alignItems = 'center';
                        div.style.padding = '2px 5px';
                        div.innerHTML = `
                            <input type="checkbox" name="pSupervisors" value="${u.id}" id="sup_${u.id}" style="margin-right:5px;">
                            <label for="sup_${u.id}" style="font-size:0.85rem; cursor:pointer;">${u.full_name || u.username}</label>
                        `;
                        container.appendChild(div);
                    });
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="color:red; font-size:0.8rem;">Error</div>';
            }
        }

        function closeGlobalPrintModal() {
            document.getElementById('globalPrintModal').style.display = 'none';
        }

        async function loadGlobalRecords() {
            const userId = document.getElementById('globalUserId').value;
            if (!userId) {
                resolveGlobalUser(); // Try to resolve
                if (!document.getElementById('globalUserId').value) return alert("Seleccione un usuario");
            }

            // Re-get in case allow resolve updated it
            const finalId = document.getElementById('globalUserId').value;
            globalSelectedUser = window.allUsersMap[finalId];

            const res = await fetch(`/payroll/records/by-user/${finalId}`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (!res.ok) return alert("Error buscando registros");

            globalRecordsCache = await res.json();

            // Calculate and Render
            let sumEff = 0;
            let sumCen = 0;
            let total = 0;

            const tbody = document.getElementById('globalTableBody');
            tbody.innerHTML = '';

            globalRecordsCache.forEach(r => {
                sumEff += r.total_effective;
                sumCen += r.total_censuses;
                total += r.total_amount;

                let detailText = `${r.total_effective} efec. | ${r.total_censuses} censos`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                   <td>
                       <div>${r.period_name}</div>
                       <small style="color:#aaa;">${r.study_code || ''}</small>
                   </td>
                   <td>${detailText}</td>
                   <td style="color:#4ade80;">$${r.total_amount.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('globalSumEff').textContent = sumEff;
            document.getElementById('globalSumCen').textContent = sumCen;
            document.getElementById('globalSumTotal').textContent = '$' + total.toLocaleString();

            document.getElementById('globalResultsArea').style.display = 'block';
        }

        function printGlobal() {
            if (!globalSelectedUser) return;

            document.getElementById('printPeriodName').textContent = "CUENTA DE COBRO UNIFICADA";
            document.getElementById('printDate').textContent = new Date().toLocaleDateString();

            const u = globalSelectedUser;
            document.getElementById('printAgentName').textContent = u.full_name || u.username;
            document.getElementById('printAgentCC').textContent = u.account_holder_cc || u.username;
            document.getElementById('printAgentBank').textContent = `${u.bank || 'Banco No Reg.'} - ${u.account_type || ''} - ${u.account_number || 'N/A'}`;

            let total = 0;
            const tbody = document.getElementById('printDetailsBody');
            tbody.innerHTML = '';

            // GROUP BY PERIOD
            // 1. Group records
            const groups = {};
            globalRecordsCache.forEach(r => {
                const key = r.period_id;
                if (!groups[key]) groups[key] = { name: r.period_name, code: r.study_code, total: 0, items: [] };
                groups[key].items.push(r);
                groups[key].total += r.total_amount;
            });

            // 2. Render Groups
            // Sort by distinct periods if needed, currently cache order is DB order (created_at)

            Object.values(groups).forEach(g => {
                total += g.total;

                // HEADER ROW
                const headerTr = document.createElement('tr');
                headerTr.style.background = '#e2e8f0'; // Light gray for subheading
                headerTr.innerHTML = `
                   <td colspan="4" style="font-weight:bold; font-size: 0.95rem; text-transform:uppercase;">
                       ${g.name} ${g.code ? '- EST ' + g.code : ''}
                   </td>
                `;
                tbody.appendChild(headerTr);

                // DETAILS
                g.items.forEach(r => {
                    let details = [];
                    try { details = JSON.parse(r.details_json); } catch (e) { }

                    if (details.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                           <td style="padding-left:20px;">Pago General</td>
                           <td style="text-align:center;">-</td>
                           <td style="text-align:right;">-</td>
                           <td style="text-align:right;">$${r.total_amount.toLocaleString()}</td>
                         `;
                        tbody.appendChild(tr);
                    } else {
                        details.forEach(d => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                               <td style="padding-left:20px;">${d.concept}</td>
                               <td style="text-align:center;">${d.qty}</td>
                               <td style="text-align:right;">$${d.rate.toLocaleString()}</td>
                               <td style="text-align:right;">$${d.total.toLocaleString()}</td>
                           `;
                            tbody.appendChild(tr);
                        });
                    }
                });
            });

            document.getElementById('printTotal').textContent = '$' + total.toLocaleString();
            window.print();
        }

        let conceptSuggestions = [];

        async function fetchSuggestions() {
            try {
                const res = await fetch('/payroll/concepts/suggestions', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    conceptSuggestions = await res.json();
                }
            } catch (e) { console.error("Error fetching suggestions", e); }
        }

        // Call immediately
        fetchSuggestions();

        function updateDefaultRates() {
            const type = document.getElementById('pType').value;
            const container = document.getElementById('conceptsContainer');
            container.innerHTML = ''; // Clear

            if (type === 'ascensor' || type === 'in_home') {
                addConceptRow('Censos', 5000);
                addConceptRow('Encuestas Efectivas', 10000);
            } else if (type === 'tdc') {
                addConceptRow('Visita TDC', 15000);
            } else {
                // Default empty row
                addConceptRow('', 0);
            }
        }

        function addConceptRow(name = '', rate = 0) {
            const container = document.getElementById('conceptsContainer');
            const rowId = 'row-' + Date.now() + Math.random().toString(36).substr(2, 9);

            const div = document.createElement('div');
            div.id = rowId;
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '2fr 1fr auto';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            div.style.alignItems = 'center';

            div.innerHTML = `
                <div style="position:relative;">
                    <input type="text" class="concept-name" placeholder="Nombre Concepto (Ej: Censo)" value="${name}" autocomplete="off">
                </div>
                <div>
                    <input type="number" class="concept-rate" placeholder="Valor Unitario" value="${rate}">
                </div>
                <button onclick="removeConceptRow('${rowId}')" style="background:#ef4444; color:white; border:none; width:30px; height:30px; border-radius:4px; cursor:pointer;" title="Eliminar">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(div);

            // Activate Autocomplete on the new input
            const input = div.querySelector('.concept-name');
            const rateInput = div.querySelector('.concept-rate');
            enableAutocomplete(input, rateInput);
        }

        function removeConceptRow(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function enableAutocomplete(inp, rateInp) {
            let currentFocus;

            inp.addEventListener("input", function (e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;

                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);

                let matches = 0;
                for (i = 0; i < conceptSuggestions.length; i++) {
                    let item = conceptSuggestions[i];
                    // Simple check: Includes (case insensitive)
                    if (item.name.toUpperCase().includes(val.toUpperCase())) {
                        if (matches > 5) break; // Limit suggestions

                        b = document.createElement("DIV");
                        // Highlight match
                        let regex = new RegExp(val, "gi");
                        b.innerHTML = item.name.replace(regex, (match) => `<strong>${match}</strong>`);
                        b.innerHTML += `<span style='float:right; color:#94a3b8; font-size:0.8em;'>$${item.rate}</span>`;
                        b.innerHTML += `<input type='hidden' value='${item.name}'>`;
                        b.innerHTML += `<input type='hidden' data-rate='${item.rate}'>`;

                        b.addEventListener("click", function (e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            const r = this.getElementsByTagName("input")[1].getAttribute('data-rate');
                            if (r && rateInp) rateInp.value = r;
                            closeAllLists();
                        });
                        a.appendChild(b);
                        matches++;
                    }
                }
            });

            inp.addEventListener("keydown", function (e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) { // Down
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // Up
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        async function createLiquidacion() {
            const name = document.getElementById('pName').value.trim();
            const code = document.getElementById('pCode').value.trim();
            const type = document.getElementById('pType').value;
            const start = document.getElementById('pStartDate').value;
            const end = document.getElementById('pEndDate').value;

            // Gather Concepts
            const concepts = [];
            const rows = document.getElementById('conceptsContainer').children;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cName = row.querySelector('.concept-name').value.trim();
                const cRate = row.querySelector('.concept-rate').value;
                if (cName && cRate) {
                    concepts.push({ name: cName, rate: parseInt(cRate) });
                }
            }

            // Strict Validation
            const errors = [];
            if (!name) errors.push("El Nombre es obligatorio.");
            if (!code) errors.push("El Código es obligatorio.");
            if (!start) errors.push("La Fecha Início es obligatoria.");
            if (!end) errors.push("La Fecha Fin es obligatoria.");
            if (concepts.length === 0) errors.push("Debe agregar al menos un Concepto de Pago.");

            if (errors.length > 0) {
                alert("Por favor corrija los siguientes errores:\n\n- " + errors.join("\n- "));
                return;
            }

            // Create Rates Snapshot for Legacy Compatibility (First Census/Effective found)
            // Or just mock them.
            let censusRate = 0;
            let effectiveRate = 0;

            // Try to find them in concepts to populate legacy fields just in case
            const cenObj = concepts.find(c => c.name.toLowerCase().includes('censo'));
            if (cenObj) censusRate = cenObj.rate;

            const effObj = concepts.find(c => c.name.toLowerCase().includes('efectiv')); // encuesta efectiva
            if (effObj) effectiveRate = effObj.rate;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('study_type', type);
            formData.append('study_code', code);
            formData.append('start_date', start);
            formData.append('end_date', end);
            formData.append('census_rate', censusRate);
            formData.append('effective_rate', effectiveRate);
            formData.append('effective_rate', effectiveRate);
            formData.append('initial_concepts', JSON.stringify(concepts));

            // Gather Supervisors
            const supCheckboxes = document.querySelectorAll('input[name="pSupervisors"]:checked');
            const supIds = Array.from(supCheckboxes).map(cb => parseInt(cb.value));
            formData.append('supervisor_ids', JSON.stringify(supIds));

            const res = await fetch('/payroll/periods', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            if (res.ok) {
                alert("Nómina Creada.");
                loadPeriods();
                fetchSuggestions();
                // Clear Form
                document.getElementById('pName').value = '';
                document.getElementById('pCode').value = '';
                document.getElementById('pStartDate').value = '';
                document.getElementById('pEndDate').value = '';
                updateDefaultRates();
            } else {
                alert("Error al crear. Intente recargar la página.");
            }
        }

        let allFetchedPeriods = [];
        async function loadPeriods() {
            const res = await fetch('/payroll/periods', { headers: { 'Authorization': 'Bearer ' + token } });
            const list = await res.json();
            allFetchedPeriods = list;
            const container = document.getElementById('periodsList');
            container.innerHTML = '';

            const isSuper = currentUser.role === 'superuser';

            // Hide Creation Card if not superuser
            document.getElementById('creationCard').style.display = isSuper ? 'block' : 'none';

            list.forEach(p => {
                // Supervisors can see active periods
                if (p.is_visible === false && !isSuper) return;

                const opacity = (p.is_visible !== false) ? '1' : '0.6';
                const start = p.start_date ? p.start_date.substring(0, 10) : (p.execution_date || '');
                const end = p.end_date ? p.end_date.substring(0, 10) : '';
                const stateLabel = (p.is_visible !== false) ? 'Activa' : 'Inactiva';
                const stateColor = (p.is_visible !== false) ? '#22c55e' : '#64748b';

                let actionsHtml = '';

                if (isSuper) {
                    if (p.is_visible !== false) {
                        actionsHtml += `<button onclick='toggleVisibility(${p.id})' style="background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px;">Desactivar</button>`;
                    } else {
                        actionsHtml += `<button onclick='toggleVisibility(${p.id})' style="background:#22c55e; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px;">Activar</button>`;
                    }
                }

                actionsHtml += `<button onclick='openDetails(${JSON.stringify(p)})' style="background:#3b82f6; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px;"><i class="fas fa-users-cog"></i> Gestionar</button>`;

                if (isSuper) {
                    actionsHtml += `<button onclick='deletePeriod(${p.id})' style="background:#dc2626; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i></button>`;
                }

                const div = document.createElement('div');
                div.style.background = 'rgba(30, 41, 59, 0.5)';
                div.style.padding = '15px';
                div.style.marginBottom = '10px';
                div.style.borderRadius = '8px';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.borderLeft = `4px solid ${stateColor}`;
                div.style.opacity = opacity;

                const checkboxHtml = `
                    <div style="margin-right: 15px;">
                        <input type="checkbox" class="period-checkbox" data-id="${p.id}" onchange="updateBulkActionsVisibility()" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                `;

                div.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        ${checkboxHtml}
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem; display:flex; align-items:center; gap:10px;">
                                ${p.name} 
                                <span style="font-size:0.8rem; background:#0f172a; padding:2px 6px; border-radius:4px;">${p.study_code || 'S/C'}</span>
                                <span style="font-size:0.75rem; background:${stateColor}; padding:2px 8px; border-radius:10px; color:white;">${stateLabel}</span>
                            </div>
                            <div style="color:#aaa; font-size:0.9rem; margin-top:4px;">
                                <i class="far fa-calendar-alt"></i> ${start} - ${end} | 
                                <span style="text-transform:uppercase; color:#93c5fd;">${p.study_type || 'General'}</span>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        ${actionsHtml}
                    </div>
                `;
                container.appendChild(div);
            });
            updateBulkActionsVisibility(); // Reset visibility if list reloaded
        }

        function toggleSelectAll(masterCb) {
            const cbs = document.querySelectorAll('.period-checkbox');
            cbs.forEach(cb => {
                cb.checked = masterCb.checked;
            });
            updateBulkActionsVisibility();
        }

        function updateBulkActionsVisibility() {
            const checked = document.querySelectorAll('.period-checkbox:checked');
            const total = document.querySelectorAll('.period-checkbox').length;
            const bulkActions = document.getElementById('bulkActions');
            if (bulkActions) {
                bulkActions.style.display = checked.length > 0 ? 'flex' : 'none';
            }

            // Sync master checkbox
            const master = document.getElementById('selectAllPeriods');
            if (master) {
                master.checked = checked.length > 0 && checked.length === total;
                master.indeterminate = checked.length > 0 && checked.length < total;
            }
        }

        async function exportBulkExcel() {
            const checked = document.querySelectorAll('.period-checkbox:checked');
            const selectedIds = Array.from(checked).map(cb => parseInt(cb.dataset.id));
            if (selectedIds.length === 0) return;

            const allRows = [];

            for (let id of selectedIds) {
                const period = allFetchedPeriods.find(p => p.id === id);
                if (!period) continue;

                const res = await fetch(`/payroll/records/${id}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const records = await res.json();

                const periodConcepts = period.concepts || [];
                if (periodConcepts.length === 0 && period.rates) {
                    if (period.rates.census) periodConcepts.push({ id: 'census', name: 'Censos', rate: period.rates.census });
                    if (period.rates.effective) periodConcepts.push({ id: 'effective', name: 'Encuestas Efectivas', rate: period.rates.effective });
                }

                records.forEach(r => {
                    const user = window.allUsersMap[r.user_id] || { full_name: 'Unknown', username: r.user_id };
                    let details = [];
                    try { details = JSON.parse(r.details_json); } catch (e) { }

                    const row = {
                        "Nómina": period.name,
                        "Estudio": period.study_code || 'Gral',
                        "Colaborador": user.full_name || user.username,
                        "CC/Usuario": user.username,
                        "Total Pagar": r.total_amount
                    };

                    // Add concept breakdowns
                    const rowMap = {};
                    details.forEach(d => {
                        const match = findMatchingConcept(d, periodConcepts);
                        if (match) {
                            if (!rowMap[match.id]) rowMap[match.id] = { qty: 0, total: 0 };
                            rowMap[match.id].qty += (d.qty || 0);
                            rowMap[match.id].total += (d.total || 0);
                        }
                    });

                    periodConcepts.forEach(c => {
                        const item = rowMap[c.id];
                        row[`${c.name} (Cant)`] = item ? item.qty : 0;
                        row[`${c.name} ($)`] = item ? item.total : 0;
                    });

                    allRows.push(row);
                });
            }

            if (allRows.length === 0) return alert("No hay datos para exportar.");

            const ws = XLSX.utils.json_to_sheet(allRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Nóminas Seleccionadas");
            XLSX.writeFile(wb, `Export_Nomina_Masiva_${new Date().getTime()}.xlsx`);
        }

        async function exportBulkPDF() {
            const checked = document.querySelectorAll('.period-checkbox:checked');
            const selectedIds = Array.from(checked).map(cb => parseInt(cb.dataset.id));
            if (selectedIds.length === 0) return;

            const win = window.open('', '', 'width=1100,height=800');
            win.document.write('<html><head><title>Reporte Masivo de Nóminas</title><style>body { font-family: sans-serif; padding: 20px; color: #333; } .page-break { page-break-after: always; } table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; } th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; } th { background: #f8fafc; color: #475569; } h2, h3 { text-align: center; color: #1e293b; } .total-row { font-weight: bold; background: #f1f5f9; }</style></head><body>');
            win.document.write('<h2>AZ MARKETING - REPORTE DE NÓMINA CONSOLIDADO</h2>');

            for (let id of selectedIds) {
                const period = allFetchedPeriods.find(p => p.id === id);
                if (!period) continue;

                const res = await fetch(`/payroll/records/${id}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const records = await res.json();

                const periodConcepts = (period.concepts || []).sort((a, b) => a.name.localeCompare(b.name));
                if (periodConcepts.length === 0 && period.rates) {
                    if (period.rates.census) periodConcepts.push({ id: 'census', name: 'Censos', rate: period.rates.census });
                    if (period.rates.effective) periodConcepts.push({ id: 'effective', name: 'Encuestas Efectivas', rate: period.rates.effective });
                }

                win.document.write(`<div class="page-break"><h3>${period.name} (${period.study_code || 'Gral'})</h3>`);
                win.document.write('<table><thead><tr><th>Colaborador</th>');
                periodConcepts.forEach(c => { win.document.write(`<th style="text-align:center;">${c.name}<br>$${c.rate.toLocaleString()}</th>`); });
                win.document.write('<th>Total</th></tr></thead><tbody>');

                let periodTotal = 0;
                records.forEach(r => {
                    const user = window.allUsersMap[r.user_id] || { full_name: 'Unknown', username: r.user_id };
                    let details = [];
                    try { details = JSON.parse(r.details_json); } catch (e) { }
                    periodTotal += r.total_amount;

                    win.document.write(`<tr><td>${user.full_name || user.username}<br><small>${user.username}</small></td>`);
                    periodConcepts.forEach(pc => {
                        let qty = 0;
                        let total = 0;
                        details.forEach(d => {
                            const match = findMatchingConcept(d, periodConcepts);
                            if (match && match.id === pc.id) {
                                qty += (d.qty || 0);
                                total += (d.total || 0);
                            }
                        });
                        win.document.write(`<td style="text-align:center;">${qty}<br><small>$${total.toLocaleString()}</small></td>`);
                    });
                    win.document.write(`<td style="font-weight:bold;">$${r.total_amount.toLocaleString()}</td></tr>`);
                });

                win.document.write(`<tr class="total-row"><td colspan="${periodConcepts.length + 1}" style="text-align:right;">TOTAL ESTUDIO:</td><td>$${periodTotal.toLocaleString()}</td></tr>`);
                win.document.write('</tbody></table></div>');
            }

            win.document.write('<script>setTimeout(() => { window.print(); window.close(); }, 1200);<\/script></body></html>');
            win.document.close();
        }

        async function toggleVisibility(id) {
            const res = await fetch(`/payroll/periods/${id}/toggle-visibility`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                loadPeriods();
            } else {
                alert("Error al cambiar visibilidad");
            }
        }

        async function deletePeriod(id) {
            if (!confirm("¿Está seguro de eliminar esta nómina por completo? Esto eliminará todos los registros de pago asociados.")) return;
            const res = await fetch(`/payroll/periods/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                loadPeriods();
            } else {
                alert("Error al eliminar");
            }
        }

        let currentPeriodMetadata = null;
        async function openDetails(period) {
            currentPeriodMetadata = period;
            currentLiquidacionId = period.id;
            // Ensure concepts are available.
            currentPeriodConcepts = period.concepts || [];

            if (currentPeriodConcepts.length === 0 && period.rates) {
                if (period.rates.census) currentPeriodConcepts.push({ id: 'census', name: 'Censos', rate: period.rates.census });
                if (period.rates.effective) currentPeriodConcepts.push({ id: 'effective', name: 'Encuestas Efectivas', rate: period.rates.effective });
            }

            document.getElementById('listCard').style.display = 'none';
            document.getElementById('creationCard').style.display = 'none';
            document.getElementById('periodDetailsCard').style.display = 'block';

            document.getElementById('detailsTitle').textContent = period.name + (period.study_code ? ` (${period.study_code})` : '');

            // Subtitle & Edit Button (Superuser Only)
            const isSuper = currentUser.role === 'superuser';
            document.getElementById('editPeriodBtn').style.display = isSuper ? 'block' : 'none';

            const subtitle = document.getElementById('detailsSubtitle');
            subtitle.innerHTML = `${currentPeriodConcepts.length} Conceptos Configurados`;

            // Build Dynamic Header
            const thead = document.querySelector('#periodDetailsCard thead tr');
            thead.innerHTML = '<th>Colaborador</th>';

            currentPeriodConcepts.sort((a, b) => a.name.localeCompare(b.name));

            currentPeriodConcepts.forEach(c => {
                thead.innerHTML += `<th style="text-align:center;">${c.name} <br><small style="color:#94a3b8; font-weight:normal;">$${c.rate.toLocaleString()}</small></th>`;
            });
            thead.innerHTML += '<th>Total Pagar</th><th>Acciones</th>';

            loadRecords(period.id);
        }

        async function exportToExcel() {
            if (!currentLiquidacionId || !currentPeriodMetadata) return;
            const res = await fetch(`/payroll/records/${currentLiquidacionId}`, { headers: { 'Authorization': 'Bearer ' + token } });
            const records = await res.json();

            // Format data for sheet
            const data = records.map(r => {
                const user = window.allUsersMap[r.user_id] || { full_name: 'Unknown', username: r.user_id };
                const row = {
                    "Colaborador": user.full_name || user.username,
                    "CC/Usuario": user.username,
                };

                // Add concepts qty and total
                let details = [];
                try { details = JSON.parse(r.details_json); } catch (e) { }

                currentPeriodConcepts.forEach(c => {
                    // Use helper to find if any detail item matches this concept
                    // But details is array of items. We need to sum them up.
                    // Actually, simpler to iterate details and bucket them like in loadRecords
                    // But here we are iterating concepts to create columns.
                    // So we need: Sum of all d in details where findMatchingConcept(d) == c

                    let qty = 0;
                    let total = 0;
                    details.forEach(d => {
                        const match = findMatchingConcept(d, currentPeriodConcepts);
                        if (match && match.id === c.id) {
                            qty += d.qty || 0;
                            total += d.total || 0;
                        }
                    });

                    row[`${c.name} (Cant)`] = qty;
                    row[`${c.name} ($)`] = total;
                });

                row["Total Pagar"] = r.total_amount;
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Nómina");

            // Auto-width for columns
            const range = XLSX.utils.decode_range(ws['!ref']);
            const wscols = [];
            for (let C = range.s.c; C <= range.e.c; ++C) {
                wscols.push({ wch: 20 });
            }
            ws['!cols'] = wscols;

            const fileName = `Nomina_${currentPeriodMetadata.study_code || 'Gral'}_${currentPeriodMetadata.name.replace(/\s+/g, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportToPDF() {
            // Re-use current table view for a clean print
            if (!currentPeriodMetadata) return;

            const title = document.getElementById('detailsTitle').textContent;
            const tableHtml = document.querySelector('#periodDetailsCard table').outerHTML;
            const date = new Date().toLocaleDateString();

            const win = window.open('', '', 'width=1100,height=800');
            win.document.write(`
                <html>
                <head>
                    <title>Nómina - ${title}</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; color: #333; }
                        h2 { text-align: center; color: #1e293b; margin-bottom: 5px; }
                        .subtitle { text-align: center; color: #64748b; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                        th { background: #f8fafc; color: #475569; font-weight: bold; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .total-cell { font-weight: bold; color: #059669; }
                        /* Hide actions column in print */
                        th:last-child, td:last-child { display: none; }
                        @media print {
                            @page { size: landscape; margin: 1cm; }
                        }
                    </style>
                </head>
                <body>
                    <h2>AZ MARKETING</h2>
                    <div class="subtitle">Resumen de Nómina: ${title} | Fecha: ${date}</div>
                    ${tableHtml}
                    <div style="margin-top: 50px; display: flex; justify-content: space-around;">
                        <div style="border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px;">Revisado por</div>
                        <div style="border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px;">Autorizado por</div>
                    </div>
                    <script>
                        setTimeout(() => { window.print(); window.close(); }, 500);
                    <\/script>
                </body>
                </html>
            `);
            win.document.close();
        }

        function closeDetails() {
            document.getElementById('periodDetailsCard').style.display = 'none';
            document.getElementById('listCard').style.display = 'block';

            // Restore creation card visibility logic locally or just reloadPeriods
            // Simplest is to reload main view logic or just reset based on role 
            const isSuper = currentUser.role === 'superuser';
            document.getElementById('creationCard').style.display = isSuper ? 'block' : 'none';

            currentPeriodConcepts = [];
        }

        function findMatchingConcept(d, concepts) {
            let cid = d.concept_id;
            // Helper for normalization
            const norm = (s) => (s || '').toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

            // 1. ID Match
            const byId = concepts.find(c => c.id == cid);
            if (byId) return byId;

            // 2. Precise Name Match
            const dNameRaw = (d.concept || '').trim().toLowerCase();
            let found = concepts.find(c => c.name.trim().toLowerCase() === dNameRaw);
            if (found) return found;

            // 3. Aggressive Normalization + Plural
            if (d.concept) {
                const dNameNorm = norm(d.concept);
                found = concepts.find(c => norm(c.name) === dNameNorm);
                if (found) return found;

                // Plurals
                found = concepts.find(c => {
                    const cNorm = norm(c.name);
                    return cNorm === dNameNorm + 's' || cNorm === dNameNorm + 'es' ||
                        dNameNorm === cNorm + 's' || dNameNorm === cNorm + 'es';
                });
                if (found) return found;
            }

            return null;
        }

        async function loadRecords(id) {
            const tbody = document.getElementById('periodDetailsBody');
            const tfoot = document.getElementById('periodDetailsFoot');
            const colSpan = 3 + currentPeriodConcepts.length; // Name + Concepts + Total + Actions

            tbody.innerHTML = `<tr><td colspan="${colSpan}">Cargando...</td></tr>`;
            tfoot.innerHTML = '';

            currentPeriodUserIds.clear();

            const res = await fetch(`/payroll/records/${id}`, { headers: { 'Authorization': 'Bearer ' + token } });
            const records = await res.json();
            tbody.innerHTML = '';

            records.forEach(r => currentPeriodUserIds.add(r.user_id));

            if (records.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding:20px; color:#aaa;">No hay personas agregadas a esta nómina.</td></tr>`;
                return;
            }

            // Totals Tracking
            let sums = {};
            currentPeriodConcepts.forEach(c => sums[c.id] = { qty: 0, total: 0 });
            let grandTotal = 0;

            records.forEach(r => {
                const user = window.allUsersMap[r.user_id] || { full_name: 'Unknown', username: r.user_id };
                grandTotal += r.total_amount;

                let details = [];
                try { details = JSON.parse(r.details_json); } catch (e) { }
                if (!Array.isArray(details)) details = [];

                // Ghost Record Heuristic: If no details but total > 0 and only 1 concept exists
                if (details.length === 0 && r.total_amount > 0 && currentPeriodConcepts.length === 1) {
                    const c = currentPeriodConcepts[0];
                    // Avoid division by zero
                    const qty = c.rate > 0 ? Math.floor(r.total_amount / c.rate) : 1;
                    details.push({
                        concept_id: c.id,
                        concept: c.name,
                        qty: qty,
                        rate: c.rate,
                        total: r.total_amount // Trust the total
                    });
                } else if (details.length === 0 && r.total_amount > 0 && currentPeriodConcepts.length > 1) {
                    // Smart Math Heuristic for Multi-Concept: Find unique concept where total is a clean multiple of rate
                    const matches = currentPeriodConcepts.filter(c => c.rate > 0 && (r.total_amount % c.rate === 0) && (r.total_amount >= c.rate));

                    // Only apply if EXACTLY ONE concept matches this math
                    if (matches.length === 1) {
                        const c = matches[0];
                        const qty = Math.floor(r.total_amount / c.rate);
                        details.push({
                            concept_id: c.id,
                            concept: c.name,
                            qty: qty,
                            rate: c.rate,
                            total: r.total_amount
                        });
                    }
                }

                let rMap = {};
                details.forEach(d => {
                    let cid = d.concept_id;

                    // Helper for normalization
                    const norm = (s) => (s || '').toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

                    // Verify if this ID is valid in current configuration
                    const isValidId = currentPeriodConcepts.some(c => c.id == cid);

                    if (!cid || !isValidId) {
                        // 1. Precise Name Match (Trimmed Case-insensitive)
                        const dNameRaw = (d.concept || '').trim().toLowerCase();
                        let found = currentPeriodConcepts.find(c => c.name.trim().toLowerCase() === dNameRaw);

                        // 2. Aggressive Normalization Match (No accents, no symbols)
                        if (!found && d.concept) {
                            const dNameNorm = norm(d.concept);
                            found = currentPeriodConcepts.find(c => norm(c.name) === dNameNorm);

                            // 2.1 Singular/Plural Match (Transporte <-> Transportes, Bonificacion <-> Bonificaciones)
                            if (!found) {
                                found = currentPeriodConcepts.find(c => {
                                    const cNorm = norm(c.name);
                                    // Check s or es suffix
                                    return cNorm === dNameNorm + 's' || cNorm === dNameNorm + 'es' ||
                                        dNameNorm === cNorm + 's' || dNameNorm === cNorm + 'es';
                                });
                            }
                        }

                        // 3. Single Concept Heuristic: If period has ONLY 1 concept, and we couldn't match, assume it's this one.
                        if (!found && currentPeriodConcepts.length === 1) {
                            found = currentPeriodConcepts[0];
                        }

                        if (found) cid = found.id;
                    }

                    if (cid) {
                        // Double check the found cid is actually in current period (if found via heuristics)
                        if (currentPeriodConcepts.some(c => c.id == cid)) {
                            if (!rMap[cid]) rMap[cid] = { qty: 0, total: 0 };
                            rMap[cid].qty += (d.qty || 0);
                            rMap[cid].total += (d.total || 0);
                        } else {
                            // Should not happen if logic is correct, but effectively this is a "Hidden" item
                            if (!rMap['hidden']) rMap['hidden'] = { qty: 0, total: 0, items: [] };
                            rMap['hidden'].total += (d.total || 0);
                            rMap['hidden'].items.push(`${d.concept} ($${d.total})`);
                        }
                    } else {
                        // No match found -> Hidden Item
                        if (!rMap['hidden']) rMap['hidden'] = { qty: 0, total: 0, items: [] };
                        rMap['hidden'].total += (d.total || 0);
                        rMap['hidden'].items.push(`${d.concept} ($${d.total})`);
                    }
                });

                let cellsHtml = '';
                currentPeriodConcepts.forEach(c => {
                    const item = rMap[c.id];
                    const qty = item ? item.qty : 0;
                    const money = item ? item.total : 0;

                    sums[c.id].qty += qty;
                    sums[c.id].total += money;

                    if (qty > 0) {
                        cellsHtml += `
                            <td style="text-align:center;">
                                <div style="font-weight:bold;">${qty}</div>
                                <div style="font-size:0.75rem; color:#aaa;">$${money.toLocaleString()}</div>
                            </td>
                         `;
                    } else {
                        cellsHtml += `<td style="text-align:center; color:#444;">-</td>`;
                    }
                });

                // Audit info
                const modifiedBy = r.last_modified_by ? `<div style="font-size:0.7rem; color:#64748b; margin-top:2px;"><i class="fas fa-user-edit"></i> ${r.last_modified_by}</div>` : '';

                // HIDDEN ITEMS WARNING
                let warningHtml = '';
                // Check if we have explicit hidden items or if math doesn't add up
                let displayedTotal = 0;
                currentPeriodConcepts.forEach(c => {
                    if (rMap[c.id]) displayedTotal += rMap[c.id].total;
                });

                // Difference tolerance (for rounding)
                if (Math.abs(r.total_amount - displayedTotal) > 100 || (rMap['hidden'] && rMap['hidden'].total > 0)) {
                    let tooltip = "";
                    if (details.length === 0) {
                        tooltip = "Este registro tiene un Total válido ($" + r.total_amount.toLocaleString() + ") pero NO tiene detalles internos (conceptos).\nNo se puede asignar a ninguna columna automáticamente.\nDebe editarlo y asignar los conceptos manualmente.";
                    } else if (rMap['hidden'] && rMap['hidden'].items.length > 0) {
                        tooltip = "Conceptos encontrados que NO coinciden con las columnas:\n\n";
                        tooltip += rMap['hidden'].items.join("\n");
                        tooltip += "\n\nSugerencia: Cambie el nombre de la columna para que coincida.";
                    } else {
                        tooltip = `Diferencia de valores calculados vs Total: $${(r.total_amount - displayedTotal).toLocaleString()}`;
                    }
                    warningHtml = `<i class="fas fa-exclamation-triangle" title="${tooltip}" style="color:#f59e0b; margin-left:5px; cursor:help;"></i>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${user.full_name || user.username}</div>
                        <div style="font-size:0.8rem; color:#aaa;">CC: ${user.username}</div>
                        ${modifiedBy}
                    </td>
                    ${cellsHtml}
                    <td style="color:#4ade80; font-weight:bold;">
                        $${r.total_amount.toLocaleString()}
                        ${warningHtml}
                    </td>
                    <td>
                        <div style="display:flex; gap:10px;">
                            <button onclick='editRecord(${JSON.stringify(r)})' class="btn-icon" title="Editar" style="color:#f59e0b;"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick='deleteRecordUser(${currentLiquidacionId}, ${r.user_id})' class="btn-icon" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Footer Totals
            let footerCells = '';
            currentPeriodConcepts.forEach(c => {
                const s = sums[c.id];
                footerCells += `
                    <td style="text-align:center; color:white;">
                        <span style="display:block; font-size:1.1rem; color:#cbd5e1;">${s.qty}</span>
                        <span style="font-size:0.8rem; color:#94a3b8;">$${s.total.toLocaleString()}</span>
                    </td>
                `;
            });

            tfoot.innerHTML = `
                <tr style="font-weight:bold; font-size:1.1rem; background:rgba(0,0,0,0.3);">
                    <td style="text-align:right;">TOTALES:</td>
                    ${footerCells}
                    <td style="color:#4ade80; vertical-align:middle;">$${grandTotal.toLocaleString()}</td>
                    <td></td>
                </tr>
            `;
        }

        async function deleteRecordUser(periodId, userId) {
            if (!confirm("¿Eliminar este registro?")) return;
            const res = await fetch(`/payroll/records/${periodId}/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                loadRecords(periodId);
                if (currentPeriodUserIds.has(userId)) currentPeriodUserIds.delete(userId);
            } else {
                alert("Error al eliminar");
            }
        }

        function rebuildUserDropdown(excludeSet = null) {
            const list = document.getElementById('manualUserList');
            if (!list) return;
            list.innerHTML = '';
            const sortedUsers = Object.values(window.allUsersMap).sort((a, b) => (a.full_name || a.username).localeCompare(b.full_name || b.username));
            sortedUsers.forEach(u => {
                if (excludeSet && excludeSet.has(u.id)) return;

                const r = (u.role || '').toLowerCase().trim();
                if (r === 'auxiliar') return;

                const opt = document.createElement('option');
                opt.value = `${u.full_name || u.username} (${u.username})`;
                list.appendChild(opt);
            });
        }

        // --- DYNAMIC MANUAL MODAL FORMS ---

        let manualItems = [];
        let manualUserId = null;

        function resolveManualUser() {
            const val = document.getElementById('manualUserInput').value;
            const match = val.match(/\((.*?)\)$/); // Match last (...)
            const username = match ? match[1] : '';

            // Find user by username (ID match or username match)
            // window.allUsersMap key is ID.
            const user = Object.values(window.allUsersMap).find(u => u.username === username);
            if (user) {
                manualUserId = user.id;
                document.getElementById('manualUserId').value = user.id;
            } else {
                manualUserId = null;
                document.getElementById('manualUserId').value = '';
            }
        }

        function resolveGlobalUser() {
            const val = document.getElementById('globalUserParams').value;
            const match = val.match(/\((.*?)\)$/);
            const username = match ? match[1] : '';
            const user = Object.values(window.allUsersMap).find(u => u.username === username);
            if (user) {
                document.getElementById('globalUserId').value = user.id;
                // For legacy compat with loadGlobalRecords that expects .value from select
                // We need to update loadGlobalRecords to use hidden input or logic
            }
        }

        function resolveGlobalAccountUser() {
            const val = document.getElementById('globalUserSelect').value;
            const match = val.match(/\((.*?)\)$/);
            const username = match ? match[1] : '';
            const user = Object.values(window.allUsersMap).find(u => u.username === username);
            if (user) {
                document.getElementById('globalAccountUserId').value = user.id;
            }
        }

        async function openManualModal() {
            if (!currentLiquidacionId) return;

            // Refresh user list from server to ensure new users appear
            await loadUsersForDropdown();

            // Populate/Filter users for this period
            rebuildUserDropdown(currentPeriodUserIds);

            // Clear
            manualItems = [];
            manualUserId = null;
            document.getElementById('manualUserInput').value = '';
            document.getElementById('manualUserInput').disabled = false;
            document.getElementById('manualUserId').value = '';

            // Populate Concepts
            populateManualConcepts();

            // Render Empty Table
            renderManualItems();

            document.getElementById('manualModal').style.display = 'block';
        }

        function editRecord(r) {
            // Populate Concepts
            populateManualConcepts();

            manualUserId = r.user_id;
            const user = window.allUsersMap[r.user_id];
            const userStr = user ? `${user.full_name || user.username} (${user.username})` : r.user_id;

            document.getElementById('manualUserInput').value = userStr;
            document.getElementById('manualUserInput').disabled = true;
            document.getElementById('manualUserId').value = r.user_id;

            // Fill Values
            let details = [];
            try { details = JSON.parse(r.details_json); } catch (e) { }
            if (!Array.isArray(details)) details = [];

            // Ghost Record Heuristic (Edit Mode)
            if (details.length === 0 && r.total_amount > 0 && currentPeriodConcepts.length === 1) {
                const c = currentPeriodConcepts[0];
                const qty = c.rate > 0 ? Math.floor(r.total_amount / c.rate) : 1;
                details.push({
                    concept_id: c.id,
                    concept: c.name,
                    qty: qty,
                    rate: c.rate,
                    total: r.total_amount
                });
            } else if (details.length === 0 && r.total_amount > 0 && currentPeriodConcepts.length > 1) {
                // Smart Math Heuristic for Multi-Concept (Edit Mode)
                const matches = currentPeriodConcepts.filter(c => c.rate > 0 && (r.total_amount % c.rate === 0) && (r.total_amount >= c.rate));

                if (matches.length === 1) {
                    const c = matches[0];
                    const qty = Math.floor(r.total_amount / c.rate);
                    details.push({
                        concept_id: c.id,
                        concept: c.name,
                        qty: qty,
                        rate: c.rate,
                        total: r.total_amount
                    });
                }
            }

            // Map details to manualItems with robust ID matching
            manualItems = details.map(d => {
                const match = findMatchingConcept(d, currentPeriodConcepts);
                const cid = match ? match.id : null;
                const cName = match ? match.name : (d.concept || 'Desconocido');

                return {
                    date: d.date || '', // YYYY-MM-DD
                    concept_id: cid,
                    concept_name: cName,
                    qty: d.qty,
                    rate: d.rate,
                    total: d.total
                };
            });

            renderManualItems();

            document.getElementById('manualModal').style.display = 'block';
        }

        function populateManualConcepts() {
            const sel = document.getElementById('newItemConcept');
            sel.innerHTML = '';
            currentPeriodConcepts.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                opt.dataset.rate = c.rate;
                sel.appendChild(opt);
            });
        }

        function addManualItem() {
            const date = document.getElementById('newItemDate').value;
            const cid = parseInt(document.getElementById('newItemConcept').value);
            const qty = parseInt(document.getElementById('newItemQty').value);

            if (!cid || !qty || qty === 0) return alert("Concepto y cantidad requeridos (distinto de 0).");

            const concept = currentPeriodConcepts.find(c => c.id === cid);
            if (!concept) return;

            manualItems.push({
                date: date,
                concept_id: concept.id,
                concept_name: concept.name,
                qty: qty,
                rate: concept.rate,
                total: qty * concept.rate
            });

            renderManualItems();

            // Reset quantity to 1
            document.getElementById('newItemQty').value = 1;
        }

        function removeManualItem(idx) {
            manualItems.splice(idx, 1);
            renderManualItems();
        }

        function renderManualItems() {
            const tbody = document.getElementById('manualItemsBody');
            tbody.innerHTML = '';
            let total = 0;

            manualItems.forEach((item, idx) => {
                total += item.total;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:5px;">${item.date || '-'}</td>
                    <td style="padding:5px;">${item.concept_name}</td>
                    <td style="padding:5px; text-align:center;">${item.qty}</td>
                    <td style="padding:5px; text-align:right;">$${item.total.toLocaleString()}</td>
                    <td style="padding:5px; text-align:center;">
                        <button onclick="removeManualItem(${idx})" style="color:#ef4444; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </td>
                 `;
                tbody.appendChild(tr);
            });

            document.getElementById('manualTotalDisplay').textContent = '$' + total.toLocaleString();
        }

        function closeManualModal() {
            document.getElementById('manualModal').style.display = 'none';
        }

        async function saveManualRecord() {
            if (!manualUserId) {
                resolveManualUser(); // Try to resolve again
                if (!manualUserId) return alert("Seleccione un colaborador válido de la lista.");
            }

            // Prepare payload
            // items: list of {concept_id, quantity, date}
            const updateItems = manualItems.map(i => ({
                concept_id: i.concept_id,
                quantity: i.qty,
                date: i.date || null
            }));

            const body = {
                total_effective: 0, // Legacy ignored by backend if items present
                total_censuses: 0,
                items: updateItems
            };

            const res = await fetch(`/payroll/records/manual?period_id=${currentLiquidacionId}&user_id=${manualUserId}`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                closeManualModal();
                loadRecords(currentLiquidacionId);
            } else {
                const err = await res.json();
                let msg = "Error al guardar";
                if (err.detail) {
                    if (typeof err.detail === 'string') {
                        msg = err.detail;
                    } else if (Array.isArray(err.detail)) {
                        msg = err.detail.map(e => `${e.loc ? e.loc.join('.') : ''}: ${e.msg}`).join('\n');
                    } else {
                        msg = JSON.stringify(err.detail);
                    }
                }
                alert("Error: " + msg);
            }
        }


        async function loadMyPayments() {
            const res = await fetch('/payroll/my-records', { headers: { 'Authorization': 'Bearer ' + token } });
            const list = await res.json();
            const container = document.getElementById('myPaymentsList');
            container.innerHTML = '';
            list.forEach(r => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                         <div>Nómina #${r.period_id}</div>
                         <div style="font-size:1.2rem; font-weight:bold; color:#4ade80;">$${r.total_amount.toLocaleString()}</div>
                         <button style="padding:5px 10px;">Ver Cuenta</button>
                    </div>
                 `;
                container.appendChild(div);
            });
        }

        // --- CONCEPT MANAGER ---
        let editingConceptId = null;

        function openConceptManager() {
            if (!currentLiquidacionId) return;
            document.getElementById('conceptManagerModal').style.display = 'block';
            loadConceptManager();
        }

        function closeConceptManager() {
            document.getElementById('conceptManagerModal').style.display = 'none';
        }

        function loadConceptManager() {
            const tbody = document.getElementById('conceptManagerBody');
            tbody.innerHTML = '';

            // sorted concepts
            currentPeriodConcepts.sort((a, b) => a.name.localeCompare(b.name));

            currentPeriodConcepts.forEach(c => {
                const tr = document.createElement('tr');
                tr.id = `concept-row-${c.id}`;
                tr.innerHTML = `
                    <td>
                        <span id="view-name-${c.id}">${c.name}</span>
                        <input type="text" id="edit-name-${c.id}" value="${c.name}" style="display:none; width:100%; padding:5px; background:#334155; border:1px solid #475569; color:white;">
                    </td>
                    <td>
                        <span id="view-rate-${c.id}">$${c.rate.toLocaleString()}</span>
                        <input type="number" id="edit-rate-${c.id}" value="${c.rate}" style="display:none; width:100%; padding:5px; background:#334155; border:1px solid #475569; color:white;">
                    </td>
                    <td style="text-align:right;">
                        <div id="actions-view-${c.id}">
                            <button onclick="editConcept(${c.id})" class="btn-icon" style="color:#f59e0b;"><i class="fas fa-pencil-alt"></i></button>
                        </div>
                        <div id="actions-edit-${c.id}" style="display:none;">
                            <button onclick="saveConceptUpdate(${c.id})" class="btn-icon" style="color:#22c55e;"><i class="fas fa-check"></i></button>
                            <button onclick="cancelEditConcept(${c.id})" class="btn-icon" style="color:#ef4444;"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editConcept(id) {
            document.getElementById(`view-name-${id}`).style.display = 'none';
            document.getElementById(`edit-name-${id}`).style.display = 'block';
            document.getElementById(`view-rate-${id}`).style.display = 'none';
            document.getElementById(`edit-rate-${id}`).style.display = 'block';

            document.getElementById(`actions-view-${id}`).style.display = 'none';
            document.getElementById(`actions-edit-${id}`).style.display = 'block';
        }

        function cancelEditConcept(id) {
            document.getElementById(`view-name-${id}`).style.display = 'block';
            document.getElementById(`edit-name-${id}`).style.display = 'none';
            document.getElementById(`view-rate-${id}`).style.display = 'block';
            document.getElementById(`edit-rate-${id}`).style.display = 'none';

            document.getElementById(`actions-view-${id}`).style.display = 'block';
            document.getElementById(`actions-edit-${id}`).style.display = 'none';
        }

        async function addNewConcept() {
            const name = document.getElementById('newConceptName').value;
            const rate = document.getElementById('newConceptRate').value;

            if (!name || !rate) return alert("Nombre y valor requeridos");

            const formData = new FormData();
            formData.append('name', name);
            formData.append('rate', rate);

            try {
                const res = await fetch(`/payroll/periods/${currentLiquidacionId}/concepts`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });

                if (res.ok) {
                    const newConcept = await res.json();

                    // Add to local list
                    currentPeriodConcepts.push(newConcept);

                    // Clear inputs
                    document.getElementById('newConceptName').value = '';
                    document.getElementById('newConceptRate').value = '';

                    // Refresh view
                    loadConceptManager();
                    reloadCurrentDetails();

                } else {
                    alert("Error creando concepto");
                }
            } catch (e) {
                console.error(e);
                alert("Error de red");
            }
        }

        async function saveConceptUpdate(id) {
            const newName = document.getElementById(`edit-name-${id}`).value;
            const newRate = document.getElementById(`edit-rate-${id}`).value;

            if (!newName || !newRate) return alert("Complete los campos.");

            try {
                const res = await fetch(`/payroll/concepts/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName, rate: parseInt(newRate) })
                });

                if (res.ok) {
                    const updated = await res.json();
                    // Update local list
                    const idx = currentPeriodConcepts.findIndex(c => c.id === id);
                    if (idx !== -1) {
                        currentPeriodConcepts[idx].name = updated.name;
                        currentPeriodConcepts[idx].rate = updated.rate;
                    }

                    cancelEditConcept(id);
                    loadConceptManager(); // Refresh table row

                    // Refresh Main Details View
                    reloadCurrentDetails();
                } else {
                    alert("Error actualizando concepto.");
                }
            } catch (e) { console.error(e); alert("Error de conexión"); }
        }

        async function reloadCurrentDetails() {
            const res = await fetch('/payroll/periods', { headers: { 'Authorization': 'Bearer ' + token } });
            const list = await res.json();
            const p = list.find(item => item.id === currentLiquidacionId);
            if (p) openDetails(p);
        }

        // --- GLOBAL ACCOUNT LOGIC ---
        let currentGlobalRecords = [];
        let currentGlobalUser = null;
        let isGlobalDetailView = false; // Toggle state

        async function openGlobalAccountModal() {
            document.getElementById('globalAccountModal').style.display = 'block';
            document.getElementById('globalAccountResult').style.display = 'none';
            // Clear
            document.getElementById('globalUserSelect').value = '';
            document.getElementById('globalAccountUserId').value = '';
        }

        function closeGlobalAccountModal() {
            document.getElementById('globalAccountModal').style.display = 'none';
        }

        async function loadGlobalAccount() {
            const userId = document.getElementById('globalAccountUserId').value;

            if (!userId) {
                resolveGlobalAccountUser();
                if (!document.getElementById('globalAccountUserId').value) return alert("Seleccione usuario");
            }

            const finalId = document.getElementById('globalAccountUserId').value;
            const sel = document.getElementById('globalUserSelect'); // Input now
            const userName = sel.value;
            // Use map data if possible for cleaner name
            const userObj = window.allUsersMap[finalId];

            currentGlobalUser = userObj || { name: userName, username: '', cedula_ciudadania: '' };
            // Fallback for name if userObj is incomplete (rare if from map)
            if (userObj && !currentGlobalUser.name) currentGlobalUser.name = userObj.full_name || userObj.username;

            const res = await fetch(`/payroll/records/by-user/${finalId}`, { headers: { 'Authorization': 'Bearer ' + token } });
            currentGlobalRecords = await res.json();

            isGlobalDetailView = false; // Reset to summary
            renderGlobalAccount();
        }

        function toggleGlobalView() {
            isGlobalDetailView = !isGlobalDetailView;
            renderGlobalAccount();
        }

        function renderGlobalAccount() {
            const container = document.getElementById('globalAccountResult');
            container.style.display = 'block';

            // Header Stats
            let totalEff = 0; // Legacy stats
            let totalCen = 0; // Legacy stats
            let grandTotal = 0;

            currentGlobalRecords.forEach(r => {
                totalEff += r.total_effective;
                totalCen += r.total_censuses;
                grandTotal += r.total_amount;
            });

            const btnLabel = isGlobalDetailView ? 'Ver Resumen' : 'Ver Detalle';
            const btnColor = isGlobalDetailView ? '#3b82f6' : '#64748b';

            container.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <div style="font-size:1.1rem; font-weight:bold; color:white;">Total Efectivas: <span style="color:#d1d5db;">${totalEff}</span></div>
                        <div style="font-size:1.1rem; font-weight:bold; color:white;">Total Censos: <span style="color:#d1d5db;">${totalCen}</span></div>
                        <div style="font-size:1.5rem; font-weight:bold; color:#4ade80; margin-top:10px;">GRAN TOTAL A PAGAR: $${grandTotal.toLocaleString()}</div>
                    </div>
                </div>

                <div style="margin-bottom:15px; text-align:right;">
                     <button onclick="toggleGlobalView()" style="background:${btnColor}; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">${btnLabel}</button>
                </div>

                <div style="background:#1e293b; border-radius:8px; overflow:hidden;">
                    <table style="width:100%; border-collapse:collapse; color:#cbd5e1;">
                        <thead style="background:#334155; color:white;">
                            ${isGlobalDetailView ? renderDetailHeader() : renderSummaryHeader()}
                        </thead>
                        <tbody id="globalTableBody">
                            ${isGlobalDetailView ? renderDetailRows() : renderSummaryRows()}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top:20px; text-align:center;">
                    <button onclick="printGlobalAccount()" class="btn-primary" style="background:#8b5cf6;"><i class="fas fa-print"></i> Imprimir Cuenta de Cobro Global</button>
                </div>
            `;
        }

        // --- SUMMARY VIEW (HOMOGENEOUS) ---
        function renderSummaryHeader() {
            return `
                <tr>
                    <th style="padding:10px; text-align:left;">Estudio</th>
                    <th style="padding:10px; text-align:left;">Concepto</th>
                    <th style="padding:10px; text-align:center;">Cantidad</th>
                    <th style="padding:10px; text-align:right;">Valor Unitario</th>
                    <th style="padding:10px; text-align:right;">Total</th>
                </tr>
            `;
        }

        function renderSummaryRows() {
            // Aggregate by Study Code + Concept Name + Rate
            const map = {}; // Key: "StudyCode|ConceptName|Rate" -> { qty, total }

            currentGlobalRecords.forEach(r => {
                let details = [];
                try { details = JSON.parse(r.details_json); } catch (e) { }
                if (!Array.isArray(details)) details = [];

                if (details.length === 0 && r.total_amount > 0) {
                    // Try Heuristics strictly for Current Period (where we have concept info)
                    if (r.period_id === currentLiquidacionId && currentPeriodConcepts && currentPeriodConcepts.length > 0) {
                        // 1. Single Concept Heuristic
                        if (currentPeriodConcepts.length === 1) {
                            const c = currentPeriodConcepts[0];
                            const qty = c.rate > 0 ? Math.floor(r.total_amount / c.rate) : 1;
                            details.push({
                                concept: c.name,
                                qty: qty,
                                rate: c.rate,
                                total: r.total_amount
                            });
                        }
                        // 2. Smart Math Heuristic
                        else {
                            const matches = currentPeriodConcepts.filter(c => c.rate > 0 && (r.total_amount % c.rate === 0) && (r.total_amount >= c.rate));
                            if (matches.length === 1) {
                                const c = matches[0];
                                const qty = Math.floor(r.total_amount / c.rate);
                                details.push({
                                    concept: c.name,
                                    qty: qty,
                                    rate: c.rate,
                                    total: r.total_amount
                                });
                            }
                        }
                    }

                    // Fallback if heuristics failed
                    if (details.length === 0) {
                        details.push({
                            concept: "Pago/Ajuste (Sin detalle)",
                            qty: 1,
                            rate: r.total_amount,
                            total: r.total_amount
                        });
                    }
                }

                // Group
                details.forEach(d => {
                    const key = `${r.study_code || 'General'}|${r.period_name || ''}|${d.concept}|${d.rate}`;
                    if (!map[key]) map[key] = {
                        study: r.study_code || 'General',
                        study_name: r.period_name || '',
                        concept: d.concept,
                        rate: d.rate,
                        qty: 0,
                        total: 0
                    };

                    map[key].qty += d.qty;
                    map[key].total += d.total;
                });
            });

            // Convert to Array and Sort
            const rows = Object.values(map).sort((a, b) => a.study.localeCompare(b.study));

            if (rows.length === 0) return '<tr><td colspan="5" style="padding:20px; text-align:center;">Sin detalles.</td></tr>';

            return rows.map(r => `
                <tr style="border-bottom:1px solid #334155;">
                    <td style="padding:10px;">
                        <span style="font-weight:bold;">${r.study}</span><br>
                        <span style="font-size:0.75rem; color:#64748b; font-style:italic;">${r.study_name}</span>
                    </td>
                    <td style="padding:10px;">${r.concept}</td>
                    <td style="padding:10px; text-align:center;">${r.qty}</td>
                    <td style="padding:10px; text-align:right;">$${r.rate.toLocaleString()}</td>
                    <td style="padding:10px; text-align:right; color:#4ade80;">$${r.total.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // --- DETAILED VIEW (DISAGGREGATED) ---
        function renderDetailHeader() {
            return `
                <tr>
                    <th style="padding:10px; text-align:left;">Fecha</th>
                    <th style="padding:10px; text-align:left;">Estudio</th>
                    <th style="padding:10px; text-align:left;">Supervisor</th>
                    <th style="padding:10px; text-align:left;">Concepto</th>
                    <th style="padding:10px; text-align:center;">Cant.</th>
                    <th style="padding:10px; text-align:right;">Valor</th>
                    <th style="padding:10px; text-align:right;">Total</th>
                </tr>
            `;
        }

        function renderDetailRows() {
            let html = '';
            // Sort records by updated_at desc
            const sortedRecords = [...currentGlobalRecords].sort((a, b) => new Date(b.updated_at || 0) - new Date(a.updated_at || 0));

            sortedRecords.forEach(r => {
                let details = [];
                try { details = JSON.parse(r.details_json); } catch (e) { }
                if (!Array.isArray(details)) details = [];

                const dateStr = r.updated_at ? new Date(r.updated_at).toLocaleString() : (r.created_at ? new Date(r.created_at).toLocaleDateString() : '-');
                const sup = r.last_modified_by || 'Sistema';

                if (details.length === 0 && r.total_amount > 0) {
                    // Try Heuristics strictly for Current Period (where we have concept info)
                    if (r.period_id === currentLiquidacionId && currentPeriodConcepts && currentPeriodConcepts.length > 0) {
                        // 1. Single Concept Heuristic
                        if (currentPeriodConcepts.length === 1) {
                            const c = currentPeriodConcepts[0];
                            const qty = c.rate > 0 ? Math.floor(r.total_amount / c.rate) : 1;
                            details.push({
                                concept: c.name,
                                qty: qty,
                                rate: c.rate,
                                total: r.total_amount
                            });
                        }
                        // 2. Smart Math Heuristic
                        else {
                            const matches = currentPeriodConcepts.filter(c => c.rate > 0 && (r.total_amount % c.rate === 0) && (r.total_amount >= c.rate));
                            if (matches.length === 1) {
                                const c = matches[0];
                                const qty = Math.floor(r.total_amount / c.rate);
                                details.push({
                                    concept: c.name,
                                    qty: qty,
                                    rate: c.rate,
                                    total: r.total_amount
                                });
                            }
                        }
                    }

                    // Fallback
                    if (details.length === 0) {
                        details.push({
                            concept: "Pago/Ajuste (Sin detalle)",
                            qty: 1,
                            rate: r.total_amount,
                            total: r.total_amount
                        });
                    }
                }

                details.forEach(d => {
                    html += `
                        <tr style="border-bottom:1px solid #334155;">
                            <td style="padding:10px; font-size:0.8rem; color:#94a3b8;">${dateStr}</td>
                            <td style="padding:10px;">
                                <b>${r.study_code || 'General'}</b><br>
                                <small style="color:#64748b;">${r.period_name || ''}</small>
                            </td>
                            <td style="padding:10px; font-size:0.8rem;">${sup}</td>
                            <td style="padding:10px;">${d.concept}</td>
                            <td style="padding:10px; text-align:center;">${d.qty}</td>
                            <td style="padding:10px; text-align:right;">$${d.rate.toLocaleString()}</td>
                            <td style="padding:10px; text-align:right; color:#4ade80;">$${d.total.toLocaleString()}</td>
                        </tr>
                     `;
                });
            });

            if (html === '') return '<tr><td colspan="7" style="padding:20px; text-align:center;">Sin detalles.</td></tr>';
            return html;
        }

        function numeroALetras(num) {
            function convertGroup(n) {
                const unidades = ['', 'UN ', 'DOS ', 'TRES ', 'CUATRO ', 'CINCO ', 'SEIS ', 'SIETE ', 'OCHO ', 'NUEVE '];
                const decenas = ['DIEZ ', 'ONCE ', 'DOCE ', 'TRECE ', 'CATORCE ', 'QUINCE ', 'DIECISES ', 'DIECISIETE ', 'DIECIOCHO ', 'DIECINUEVE ', 'VEINTE ', 'TREINTA ', 'CUARENTA ', 'CINCUENTA ', 'SESENTA ', 'SETENTA ', 'OCHENTA ', 'NOVENTA '];
                const centenas = ['', 'CIENTO ', 'DOSCIENTOS ', 'TRESCIENTOS ', 'CUATROCIENTOS ', 'QUINIENTOS ', 'SEISCIENTOS ', 'SETECIENTOS ', 'OCHOCIENTOS ', 'NOVECIENTOS '];

                let output = '';

                if (n >= 100) {
                    if (n === 100) output += 'CIEN ';
                    else output += centenas[Math.floor(n / 100)];
                    n %= 100;
                }

                if (n >= 20) {
                    if (n === 20) output += 'VEINTE '; // Specific fix
                    else {
                        let ten = Math.floor(n / 10);
                        // decenas array maps: 10->index 0, 11->index 1... 19->index 9. 20->index 10...
                        // My previous mapping was loose. Let's strict map:
                        // 0-9: DIEZ..DIECINUEVE
                        // 10: VEINTE
                        // 11: TREINTA
                        // Let's restart array for clarity
                        const tens = ['', '', 'VEINTE ', 'TREINTA ', 'CUARENTA ', 'CINCUENTA ', 'SESENTA ', 'SETENTA ', 'OCHENTA ', 'NOVENTA '];
                        const teens = ['DIEZ ', 'ONCE ', 'DOCE ', 'TRECE ', 'CATORCE ', 'QUINCE ', 'DIECISEIS ', 'DIECISIETE ', 'DIECIOCHO ', 'DIECINUEVE '];

                        output += tens[Math.floor(n / 10)];
                        if (n % 10 > 0) output += 'Y ' + unidades[n % 10];
                    }
                } else if (n >= 10) {
                    const teens = ['DIEZ ', 'ONCE ', 'DOCE ', 'TRECE ', 'CATORCE ', 'QUINCE ', 'DIECISEIS ', 'DIECISIETE ', 'DIECIOCHO ', 'DIECINUEVE '];
                    output += teens[n - 10];
                } else if (n > 0) {
                    output += unidades[n];
                }
                return output;
            }

            if (num === 0) return 'CERO PESOS M/CTE';

            let output = '';
            // Millions
            if (num >= 1000000) {
                let millions = Math.floor(num / 1000000);
                if (millions === 1) output += 'UN MILLON ';
                else output += convertGroup(millions) + 'MILLONES ';
                num %= 1000000;
            }

            // Thousands
            if (num >= 1000) {
                let thousands = Math.floor(num / 1000);
                if (thousands === 1) output += 'MIL ';
                else output += convertGroup(thousands) + 'MIL ';
                num %= 1000;
            }

            // Hundreds
            if (num > 0) {
                output += convertGroup(num);
            }

            return output.trim() + ' PESOS M/CTE';
        }

        function printGlobalAccount() {
            // Print what is currently visible? Or always Summary?
            // User: "para imprimir que valla todo homogeneo" (Homogeneous/Summary)
            // But usually users want to print what they see.
            // Let's print the Current View. 
            // If user wants homogeneous, they select Summary (default) then print.

            const tableContent = document.querySelector('#globalAccountResult table').outerHTML;

            // Calculate Grand Total again to be sure (or grab from UI)
            let grandTotal = 0;
            currentGlobalRecords.forEach(r => grandTotal += r.total_amount);

            const totals = document.querySelector('#globalAccountResult > div:first-child').innerHTML; // Stats header
            const userName = currentGlobalUser.name;
            const userCC = currentGlobalUser.cc;
            const title = isGlobalDetailView ? "CUENTA DE COBRO DETALLADA" : "CUENTA DE COBRO UNIFICADA";

            // Date with Time
            const date = new Date().toLocaleString('es-CO', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: true
            });

            const amountInWords = numeroALetras(grandTotal);

            const win = window.open('', '', 'width=900,height=700');
            win.document.write(`
                <html>
                <head>
                    <title>Imprimir Cuenta Global</title>
                    <style>
                        body { font-family: sans-serif; padding: 30px 40px; }
                        .top-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                        .brand h2 { margin: 0; font-size: 1.6rem; text-transform: uppercase; }
                        .brand p { margin: 2px 0 0 0; font-size: 0.9rem; color: #333; }
                        .meta { text-align: right; }
                        .meta h3 { margin: 0; font-size: 1.1rem; text-transform: uppercase; }
                        .meta p { margin: 2px 0 0 0; font-size: 0.85rem; color: #555; }
                        
                        .info { font-weight: bold; font-size: 1rem; line-height: 1.4; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; font-size: 0.9rem; }
                        th { background: #eee; }
                        
                        .totals { margin-top:20px; text-align:right; font-size:1.1rem; font-weight:bold; }
                        
                        .signatures { margin-top: 60px; display: flex; justify-content: space-between; }
                        .sig-line { border-top: 1px solid #000; width: 40%; text-align: center; padding-top: 5px; font-size: 0.9rem; }
                    </style>
                </head>
                <body>
                    <div class="top-header">
                        <div class="brand">
                            <h2>AZ MARKETING</h2>
                            <p>NIT: 900.123.456-7</p>
                        </div>
                        <div class="meta">
                            <h3>${title}</h3>
                            <p>${date}</p>
                        </div>
                    </div>
                    
                    <div class="info">
                        <div style="display:grid; grid-template-columns: auto 1fr; gap: 5px 10px;">
                            <div>NOMBRE:</div> <div>${currentGlobalUser.full_name || currentGlobalUser.username || 'N/A'}</div>
                            <div>CC:</div> <div>${currentGlobalUser.cedula_ciudadania || 'N/A'}</div>
                            <div>CELULAR:</div> <div>${currentGlobalUser.phone_number || 'N/A'}</div>
                            <div>CUENTA:</div> <div>${currentGlobalUser.bank || 'Banco No Reg.'} - ${currentGlobalUser.account_type || ''} - ${currentGlobalUser.account_number || 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${tableContent}
                    
                    <div class="totals">
                        ${totals.replace(/color:white;/g, 'color:black;').replace(/color:#d1d5db;/g, 'color:black;').replace(/color:#4ade80;/g, 'color:black;')} 
                    </div>
                    
                    <div style="margin-top: 10px; font-weight: bold; font-size: 0.85rem; border-top: 1px dotted #ccc; padding-top: 5px;">
                        SON: ${amountInWords}
                    </div>
                    
                    <div class="signatures">
                        <div class="sig-line">Firma Beneficiario</div>
                        <div class="sig-line">Aprobado AZ Marketing</div>
                        table.querySelectorAll('th').forEach(th => { th.style.background = '#eee'; th.style.color = 'black'; });
                        table.querySelectorAll('td').forEach(td => { td.style.color = 'black'; });
                        window.print();
                    <\/script>
</body>

</html>
`);
            win.document.close();
        }

        init();

        // Load supervisors if creation card exists
        if (document.getElementById('creationCard')) {
            loadSupervisorsForAssignment();
        }
    </script>

    <!-- Modal Concept Manager -->
    <div id="conceptManagerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeConceptManager()">&times;</span>
            <h3 style="color:#3b82f6; margin-bottom:15px;"><i class="fas fa-tags"></i> Gestionar Conceptos</h3>
            <p style="color:#cbd5e1; margin-bottom:20px;">Edite los nombres o valores de los conceptos de esta nómina.
            </p>

            <div
                style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; margin-bottom:15px; display:flex; gap:10px; align-items:end;">
                <div style="flex:1;">
                    <label style="font-size:0.8rem; display:block; margin-bottom:4px; color:#cbd5e1;">Nuevo
                        Concepto</label>
                    <input type="text" id="newConceptName" class="form-input" placeholder="Nombre" style="margin:0;">
                </div>
                <div style="width:120px;">
                    <label style="font-size:0.8rem; display:block; margin-bottom:4px; color:#cbd5e1;">Valor</label>
                    <input type="number" id="newConceptRate" class="form-input" placeholder="0" style="margin:0;">
                </div>
                <button onclick="addNewConcept()" class="btn-primary"
                    style="margin:0; height:36px; background:#22c55e;"><i class="fas fa-plus"></i></button>
            </div>

            <table style="width:100%; border-collapse:collapse; color:#cbd5e1;">
                <thead>
                    <tr style="border-bottom:1px solid #334155;">
                        <th style="text-align:left; padding:8px;">Nombre</th>
                        <th style="text-align:left; padding:8px;">Valor Unitario</th>
                        <th style="text-align:right; padding:8px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="conceptManagerBody">
                    <!-- Dynamic -->
                </tbody>
            </table>

            <div style="margin-top:20px; text-align:right;">
                <button onclick="closeConceptManager()" class="btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- Modal Global Account -->
    <div id="globalAccountModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeGlobalAccountModal()">&times;</span>
            <h3 style="color:#3b82f6; margin-bottom:15px;"><i class="fas fa-file-invoice-dollar"></i> Cuenta de Cobro
                Unificada</h3>
            <p style="color:#cbd5e1; margin-bottom:20px;">Consulte y genere la cuenta de cobro global para un
                colaborador.</p>

            <div class="form-group">
                <label>Seleccione Colaborador</label>
                <div style="display:flex; gap:10px;">
                    <input list="globalUserList" id="globalUserSelect" class="form-input" style="flex:1;"
                        placeholder="Buscar colaborador..." onchange="resolveGlobalAccountUser()">
                    <input type="hidden" id="globalAccountUserId">

                    <button onclick="loadGlobalAccount()" class="btn-primary" style="margin:0;">Consultar</button>
                </div>
            </div>

            <div id="globalAccountResult"
                style="display:none; margin-top:20px; border-top:1px solid #334155; padding-top:20px;">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>
    <!-- Loans Modal -->
    <div id="loansModal" class="modal">
        <div class="modal-content" style="max-width: 900px; display:flex; flex-direction:column; gap:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:#eab308; margin:0;"><i class="fas fa-hand-holding-usd"></i> Gestión de Préstamos</h3>
                <span class="close" onclick="closeLoansModal()">&times;</span>
            </div>

            <div style="display: flex; gap: 20px; flex:1; min-height:400px;">
                <!-- Left: User List -->
                <div style="flex: 1; display:flex; flex-direction:column; gap:10px;">
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px;">
                        <label style="font-size:0.9rem; color:#aaa;">Buscar Usuario</label>
                        <input list="loanUserList" id="loanUserSearch" class="form-input" placeholder="Nombre..."
                            onchange="resolveLoanUser()">
                        <datalist id="loanUserList"></datalist>
                        <input type="hidden" id="loanUserId">
                    </div>

                    <button onclick="openNewLoanForm()"
                        style="width:100%; padding: 10px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight:bold; cursor:pointer;">
                        <i class="fas fa-plus"></i> Nuevo Préstamo
                    </button>
                </div>

                <!-- Right: Details -->
                <div
                    style="flex: 2; border-left: 1px solid #334155; padding-left: 20px; display:flex; flex-direction:column;">
                    <h4 id="loanUserName" style="margin-top:0; border-bottom:1px solid #334155; padding-bottom:10px;">
                        Seleccione un usuario</h4>

                    <div id="loanDetailsArea" style="display:none; flex:1;">
                        <div style="background: rgba(0,0,0,0.2); margin-bottom: 15px; border-radius:6px; padding:10px;">
                            <h5 style="margin-top:0;">Préstamos Activos</h5>
                            <div style="max-height:200px; overflow-y:auto;">
                                <table class="data-table" style="font-size: 0.9rem;">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Descripción</th>
                                            <th>Monto Original</th>
                                            <th>Saldo Pendiente</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loansTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="paymentArea"
                            style="display:none; background: rgba(30,41,59,0.5); padding: 15px; border-radius: 6px; border:1px solid #475569;">
                            <h5 style="margin-top:0; color:#4ade80;">Registrar Abono / Pago</h5>
                            <input type="hidden" id="selectedLoanId">
                            <div style="margin-bottom:5px; color:#aaa; font-size:0.9rem;">Abonar al préstamo: <span
                                    id="paymentLoanDesc" style="color:white;"></span></div>
                            <div style="display:grid; grid-template-columns: 1fr 2fr auto; gap: 10px;">
                                <input type="number" id="paymentAmount" placeholder="Monto" class="form-input"
                                    style="margin:0;">
                                <input type="text" id="paymentNotes" placeholder="Notas (opcional)" class="form-input"
                                    style="margin:0;">
                                <button onclick="submitPayment()"
                                    style="background: #3b82f6; color: white; border: none; padding: 0 20px; border-radius: 4px; font-weight:bold; cursor:pointer;">Pagar</button>
                            </div>
                        </div>
                    </div>

                    <!-- New Loan Form -->
                    <div id="newLoanForm"
                        style="display:none; background: rgba(30,41,59,0.8); padding: 20px; border-radius: 6px; border:1px solid #475569;">
                        <h5 style="margin-top:0; color:#22c55e;">Crear Nuevo Préstamo</h5>
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="newLoanUserDisplay" readonly class="form-input"
                                style="background: #334155; color:#aaa;">
                            <input type="hidden" id="newLoanUserId">
                        </div>
                        <div class="form-group">
                            <label>Monto a Prestar</label>
                            <input type="number" id="newLoanAmount" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Descripción / Motivo</label>
                            <input type="text" id="newLoanDesc" class="form-input">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button onclick="submitNewLoan()"
                                style="background: #22c55e; color: white; border: none; padding: 10px; border-radius: 6px; flex:1; font-weight:bold; cursor:pointer;">Crear
                                Préstamo</button>
                            <button onclick="cancelNewLoan()"
                                style="background: transparent; color: #cbd5e1; border: 1px solid #475569; padding: 10px; border-radius: 6px; cursor:pointer;">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // --- LOAN MANAGEMENT LOGIC ---
        function openLoansModal() {
            document.getElementById('loansModal').style.display = 'block';
            resetLoanUI();

            // Populate datalist if empty
            const dl = document.getElementById('loanUserList');
            if (dl.options.length === 0 && window.allUsersMap) {
                Object.values(window.allUsersMap).forEach(u => {
                    const op = document.createElement('option');
                    op.value = u.full_name || u.username;
                    op.setAttribute('data-id', u.id);
                    dl.appendChild(op);
                });
            }
        }

        function closeLoansModal() {
            document.getElementById('loansModal').style.display = 'none';
        }

        function resetLoanUI() {
            document.getElementById('loanUserSearch').value = '';
            document.getElementById('loanUserId').value = '';
            document.getElementById('loanUserName').innerText = 'Seleccione un usuario';
            document.getElementById('loanDetailsArea').style.display = 'none';
            document.getElementById('newLoanForm').style.display = 'none';
        }

        function resolveLoanUser() {
            const val = document.getElementById('loanUserSearch').value;
            if (!val) return;

            // Find in datalist logic (similar to other resolves)
            const opts = document.getElementById('loanUserList').options;
            let id = null;
            for (let i = 0; i < opts.length; i++) {
                if (opts[i].value === val) {
                    id = opts[i].getAttribute('data-id');
                    break;
                }
            }

            if (id) {
                document.getElementById('loanUserId').value = id;
                document.getElementById('loanUserName').innerText = val;
                loadUserLoans(id);
            }
        }

        async function loadUserLoans(userId) {
            if (!userId) userId = document.getElementById('loanUserId').value;
            // Ensure UI shows loans
            document.getElementById('loanDetailsArea').style.display = 'flex';
            document.getElementById('newLoanForm').style.display = 'none';
            document.getElementById('paymentArea').style.display = 'none';

            try {
                const res = await fetch(`/loans/user/${userId}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const loans = await res.json();

                const tbody = document.getElementById('loansTableBody');
                tbody.innerHTML = '';

                if (loans.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No tiene préstamos registrados.</td></tr>';
                    return;
                }

                loans.forEach(l => {
                    const tr = document.createElement('tr');
                    const dateStr = new Date(l.created_at).toLocaleDateString();
                    tr.style.opacity = l.status === 'paid' ? '0.5' : '1';

                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${l.description}</td>
                        <td>$${l.amount.toLocaleString()}</td>
                        <td style="font-weight:bold; color:${l.balance > 0 ? '#ef4444' : '#4ade80'};">$${l.balance.toLocaleString()}</td>
                        <td>
                            ${l.status === 'active' ? `<button onclick="setupPayment(${l.id}, '${l.description}', ${l.balance})" style="background:#3b82f6; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Abonar</button>` : '<span style="color:#4ade80; font-weight:bold;">PAGADO</span>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); alert("Error cargando préstamos"); }
        }

        function openNewLoanForm() {
            const userId = document.getElementById('loanUserId').value;
            const userName = document.getElementById('loanUserSearch').value;

            if (!userId) return alert("Primero busque y seleccione un usuario");

            document.getElementById('loanDetailsArea').style.display = 'none';
            document.getElementById('newLoanForm').style.display = 'block';

            document.getElementById('newLoanUserId').value = userId;
            document.getElementById('newLoanUserDisplay').value = userName;
            document.getElementById('newLoanAmount').value = '';
            document.getElementById('newLoanDesc').value = '';
        }

        function cancelNewLoan() {
            document.getElementById('newLoanForm').style.display = 'none';
            document.getElementById('loanDetailsArea').style.display = 'flex';
        }

        async function submitNewLoan() {
            const userId = document.getElementById('newLoanUserId').value;
            const amount = document.getElementById('newLoanAmount').value;
            const desc = document.getElementById('newLoanDesc').value;

            if (!amount || !desc) return alert("Complete todos los campos");

            try {
                const res = await fetch('/loans', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId), amount: parseInt(amount), description: desc })
                });

                if (res.ok) {
                    alert("Préstamo creado correctamente");
                    cancelNewLoan();
                    loadUserLoans(userId);
                } else {
                    alert("Error creando préstamo");
                }
            } catch (e) { console.error(e); alert("Error de red"); }
        }

        function setupPayment(loanId, desc, balance) {
            document.getElementById('paymentArea').style.display = 'block';
            document.getElementById('selectedLoanId').value = loanId;
            document.getElementById('paymentLoanDesc').innerText = `${desc} (Saldo: $${balance.toLocaleString()})`;
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';

            // Scroll to payment area
            document.getElementById('paymentArea').scrollIntoView({ behavior: 'smooth' });
        }

        async function submitPayment() {
            const loanId = document.getElementById('selectedLoanId').value;
            const amount = document.getElementById('paymentAmount').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!amount) return alert("Ingrese el monto del abono");

            try {
                const res = await fetch(`/loans/${loanId}/payment`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseInt(amount), notes: notes })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert("Abono registrado. Nuevo saldo: $" + data.new_balance.toLocaleString());
                    document.getElementById('paymentArea').style.display = 'none';
                    loadUserLoans(); // Refresh list
                } else {
                    alert("Error registrando pago");
                }
            } catch (e) { console.error(e); alert("Error de red"); }
        }
    </script>

</html>