<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina - AZ Marketing</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* SCROLL FIX */
        body {
            height: auto !important;
            min-height: 100vh;
            overflow-y: auto !important;
        }

        .payroll-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            color: white;
            padding-bottom: 50px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table th {
            background: rgba(15, 23, 42, 0.8);
            color: #cbd5e1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e293b;
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #334155;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            color: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        /* Print Styles */
        .print-view {
            background: white;
            color: black;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .print-view,
            .print-view * {
                visibility: visible;
            }

            .print-view {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }
        }
    </style>
</head>

<body>
    <div class="payroll-container">
        <header class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="/" style="color: white; text-decoration: none;"><i class="fas fa-arrow-left"></i> Volver</a>
                <h1><i class="fas fa-money-bill-wave"></i> Gestión de Nómina</h1>
            </div>
            <div id="rolDisplay"></div>
        </header>

        <!-- ADMIN VIEW -->
        <div id="adminView" style="display: none;">

            <!-- TOP ACTIONS: Global Print -->
            <div style="margin-bottom: 2rem; display: flex; justify-content: flex-end;">
                <button onclick="openGlobalPrintModal()"
                    style="background: #8b5cf6; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    <i class="fas fa-print"></i> Consultar Pagos / Imprimir Cuenta Global
                </button>
            </div>

            <!-- CREATION CARD -->
            <div class="card" id="creationCard"
                style="margin-bottom: 2rem; border-left: 4px solid var(--primary-color);">
                <h3><i class="fas fa-plus-square"></i> Registrar Nueva Nómina</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: end;">
                    <div class="form-group">
                        <label>Nombre del Estudio / Concepto</label>
                        <input type="text" id="pName" placeholder="Ej: Proyecto Ascensores Enero">
                    </div>
                    <div class="form-group">
                        <label>Código Estudio</label>
                        <input type="text" id="pCode" placeholder="Ej: 2548">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:10px;">
                    <div class="form-group">
                        <label>Tipo de Estudio</label>
                        <select id="pType" class="form-input" onchange="updateDefaultRates()">
                            <option value="ascensor">Ascensor</option>
                            <option value="in_home">In Home</option>
                            <option value="tdc">Test de Compra (TDC)</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group"></div>
                </div>

                <!-- DATES ROW -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:10px;">
                    <div class="form-group">
                        <label>Fecha Inicio</label>
                        <input type="date" id="pStartDate">
                    </div>
                    <div class="form-group">
                        <label>Fecha Cierre</label>
                        <input type="date" id="pEndDate">
                    </div>
                </div>

                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: end; margin-top:10px;">
                    <div class="form-group">
                        <label>Tarifa Censo ($)</label>
                        <input type="number" id="pRateCensus" value="5000">
                    </div>
                    <div class="form-group">
                        <label>Tarifa Encuesta Efectiva ($)</label>
                        <input type="number" id="pRateEffective" value="10000">
                    </div>

                    <button class="btn-submit" onclick="createLiquidacion()"
                        style="margin-bottom: 0px; height: 42px; grid-column: span 2;">
                        <i class="fas fa-save"></i> Crear Nómina
                    </button>
                </div>
            </div>

            <!-- LIST CARD -->
            <div class="card" id="listCard">
                <h3>Historial de Nóminas</h3>
                <div id="periodsList"></div>
            </div>

            <!-- DETAILS CARD (Initially Hidden) -->
            <div class="card" id="periodDetailsCard"
                style="margin-top: 2rem; display: none; border-top: 4px solid #f59e0b;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h3 id="detailsTitle" style="margin:0;">Detalle</h3>
                        <p id="detailsSubtitle" style="color:#aaa; font-size:0.9rem; margin:0;"></p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openManualModal()"
                            style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-user-plus"></i> Agregar Persona
                        </button>
                        <button onclick="closeDetails()"
                            style="background: transparent; color: white; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-arrow-left"></i> Volver a Lista
                        </button>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Efectivas</th>
                            <th>Censos</th>
                            <th>Total Pagar</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="periodDetailsBody"></tbody>
                    <tfoot id="periodDetailsFoot" style="background: rgba(15, 23, 42, 0.8); font-weight: bold;"></tfoot>
                </table>
            </div>
        </div>

        <!-- AGENT VIEW -->
        <div id="agentView" style="display: none;">
            <div class="card">
                <h3>Mis Pagos Disponibles</h3>
                <div id="myPaymentsList"></div>
            </div>
        </div>

        <!-- Manual Entry Modal -->
        <div id="manualModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeManualModal()">&times;</span>
                <h3>Registrar Actividad</h3>
                <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 1rem;">Seleccione quién trabajó y qué
                    cantidades hizo.</p>

                <div class="form-group">
                    <label>Colaborador</label>
                    <select id="manualUser" class="form-input"></select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Cant. Efectivas</label>
                        <input type="number" id="manualEffective" value="0">
                        <small style="color:#aaa;">x <span id="displayRateEff"></span></small>
                    </div>
                    <div class="form-group">
                        <label>Cant. Censos</label>
                        <input type="number" id="manualCensus" value="0">
                        <small style="color:#aaa;">x <span id="displayRateCen"></span></small>
                    </div>
                </div>

                <button class="btn-submit" onclick="saveManualRecord()">Guardar Registro</button>
            </div>
        </div>

        <!-- Global Print Modal -->
        <div id="globalPrintModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeGlobalPrintModal()">&times;</span>
                <h3>Consultar Pagos / Cuenta Global</h3>
                <p style="color: #94a3b8; margin-bottom: 20px;">Seleccione un colaborador para ver todos sus pagos
                    pendientes y generar la cuenta de cobro unificada.</p>

                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <select id="globalUserParams" class="form-input" style="flex:1;"></select>
                    <button onclick="loadGlobalRecords()"
                        style="background:#3b82f6; color:white; border:none; padding:0 20px; border-radius:6px;">Consultar</button>
                </div>

                <div id="globalResultsArea" style="display:none;">
                    <div style="background: rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Total Efectivas:</span>
                            <span id="globalSumEff" style="font-weight:bold;">0</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Total Censos:</span>
                            <span id="globalSumCen" style="font-weight:bold;">0</span>
                        </div>
                        <div
                            style="display:flex; justify-content:space-between; font-size:1.2rem; border-top:1px solid #444; padding-top:10px;">
                            <span>GRAN TOTAL A PAGAR:</span>
                            <span id="globalSumTotal" style="color:#4ade80; font-weight:bold;">$0</span>
                        </div>
                    </div>

                    <div
                        style="height:200px; overflow-y:auto; margin-bottom:20px; border:1px solid #333; border-radius:6px;">
                        <table class="data-table" style="font-size:0.9rem;">
                            <thead>
                                <tr>
                                    <th>Estudio</th>
                                    <th>Detalle</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="globalTableBody"></tbody>
                        </table>
                    </div>

                    <button onclick="printGlobal()" class="btn-submit" style="background:#8b5cf6;"><i
                            class="fas fa-print"></i> Imprimir Cuenta de Cobro Global</button>
                </div>
            </div>
        </div>

    </div>

    <!-- PRINT TEMPLATE -->
    <div id="printArea" class="print-view">
        <table style="width: 100%; margin-bottom: 20px;">
            <tr>
                <td style="width: 50%; vertical-align: top;">
                    <!-- Logo Placeholder -->
                    <div style="font-weight:bold; font-size:1.5rem; color:#444;">AZ MARKETING</div>
                    <p style="margin:5px 0;">NIT: 900.123.456-7</p>
                </td>
                <td style="width: 50%; text-align: right; vertical-align: top;">
                    <h1 style="margin: 0;">CUENTA DE COBRO</h1>
                    <h3 id="printPeriodName" style="margin: 5px 0;"></h3>
                    <p id="printDate"></p>
                </td>
            </tr>
        </table>

        <div style="border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 15px 0; margin-bottom: 30px;">
            <table style="width: 100%;">
                <tr>
                    <td><strong>NOMBRE:</strong> <span id="printAgentName"></span></td>
                    <td><strong>CC:</strong> <span id="printAgentCC"></span></td>
                </tr>
                <tr>
                    <td colspan="2"><strong>CUENTA:</strong> <span id="printAgentBank"></span></td>
                </tr>
            </table>
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px;" border="1" cellpadding="8">
            <thead>
                <tr style="background: #f1f5f9;">
                    <th>Concepto / Actividad</th>
                    <th style="text-align:center;">Cantidad</th>
                    <th style="text-align:right;">Valor Unitario</th>
                    <th style="text-align:right;">Total</th>
                </tr>
            </thead>
            <tbody id="printDetailsBody">
                <!-- Rows -->
            </tbody>
            <tfoot>
                <tr style="background: #f1f5f9; font-weight: bold;">
                    <td colspan="3" style="text-align: right;">NETO A PAGAR:</td>
                    <td style="text-align:right;" id="printTotal"></td>
                </tr>
            </tfoot>
        </table>

        <div style="margin-top: 80px; display: flex; justify-content: space-between;">
            <div style="border-top: 1px solid black; width: 40%; text-align: center; padding-top: 5px;">
                Firma Beneficiario
            </div>
            <div style="border-top: 1px solid black; width: 40%; text-align: center; padding-top: 5px;">
                Aprobado AZ Marketing
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        let currentUser = null;
        let pRates = { census: 5000, effective: 10000 };
        let currentLiquidacionId = null;
        let currentPeriodUserIds = new Set();
        let globalRecordsCache = [];
        let globalSelectedUser = null;

        async function init() {
            try {
                const res = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
                currentUser = await res.json();

                document.getElementById('rolDisplay').textContent = `Usuario: ${currentUser.username} (${currentUser.role})`;

                if (['superuser', 'coordinator', 'supervisor'].includes(currentUser.role)) {
                    document.getElementById('adminView').style.display = 'block';
                    loadPeriods();
                    loadUsersForDropdown();
                } else {
                    document.getElementById('agentView').style.display = 'block';
                    loadMyPayments();
                }

                // Default Dates
                const today = new Date();
                document.getElementById('pEndDate').valueAsDate = today;
                document.getElementById('pStartDate').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);

            } catch (e) { console.error(e); }
        }

        async function loadUsersForDropdown() {
            const uRes = await fetch('/users', { headers: { 'Authorization': 'Bearer ' + token } });
            const uList = await uRes.json();
            window.allUsersMap = {};
            const sel = document.getElementById('manualUser');
            sel.innerHTML = '';

            // Populate Global Search too
            const globSel = document.getElementById('globalUserParams');
            globSel.innerHTML = '<option value="">Seleccione...</option>';

            const sorted = uList.sort((a, b) => (a.full_name || a.username).localeCompare(b.full_name || b.username));

            sorted.forEach(u => {
                window.allUsersMap[u.id] = u;

                // FILTER: Do not show 'auxiliar' role or 'superuser' in the payroll addition list
                // Unless the user specifically asks for them, usually they are system accounts.
                // Keeping 'agent' and 'supervisor' (if they receive payments).
                if (u.role === 'auxiliar' || u.role === 'superuser') return;

                // Add to manual dropdown (initial state)
                let opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = u.full_name || u.username;
                sel.appendChild(opt);

                // Add to Global Dropdown
                let opt2 = opt.cloneNode(true);
                globSel.appendChild(opt2);
            });
        }

        // --- GLOBAL PRINT LOGIC ---
        async function openGlobalPrintModal() {
            document.getElementById('globalPrintModal').style.display = 'block';
            document.getElementById('globalResultsArea').style.display = 'none';

            // Populate Dropdown with ONLY active users
            const globSel = document.getElementById('globalUserParams');
            globSel.innerHTML = '<option>Cargando...</option>';

            try {
                const res = await fetch('/payroll/active-users', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    const activeUsers = await res.json();
                    globSel.innerHTML = '<option value="">Seleccione...</option>';

                    const sorted = activeUsers.sort((a, b) => (a.full_name || a.username).localeCompare(b.full_name || b.username));

                    sorted.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id;
                        opt.textContent = u.full_name || u.username;
                        globSel.appendChild(opt);
                    });

                    // Update cache for name resolution
                    activeUsers.forEach(u => {
                        // Ensure they are in the map for print display
                        if (!window.allUsersMap[u.id]) window.allUsersMap[u.id] = u;
                    });
                }
            } catch (e) {
                globSel.innerHTML = '<option>Error</option>';
            }
        }
        function closeGlobalPrintModal() {
            document.getElementById('globalPrintModal').style.display = 'none';
        }

        async function loadGlobalRecords() {
            const userId = document.getElementById('globalUserParams').value;
            if (!userId) return alert("Seleccione un usuario");

            globalSelectedUser = window.allUsersMap[userId];

            const res = await fetch(`/payroll/records/by-user/${userId}`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (!res.ok) return alert("Error buscando registros");

            globalRecordsCache = await res.json();

            // Calculate and Render
            let sumEff = 0;
            let sumCen = 0;
            let total = 0;

            const tbody = document.getElementById('globalTableBody');
            tbody.innerHTML = '';

            globalRecordsCache.forEach(r => {
                sumEff += r.total_effective;
                sumCen += r.total_censuses;
                total += r.total_amount;

                let detailText = `${r.total_effective} efec. | ${r.total_censuses} censos`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                   <td>
                       <div>${r.period_name}</div>
                       <small style="color:#aaa;">${r.study_code || ''}</small>
                   </td>
                   <td>${detailText}</td>
                   <td style="color:#4ade80;">$${r.total_amount.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('globalSumEff').textContent = sumEff;
            document.getElementById('globalSumCen').textContent = sumCen;
            document.getElementById('globalSumTotal').textContent = '$' + total.toLocaleString();

            document.getElementById('globalResultsArea').style.display = 'block';
        }

        function printGlobal() {
            if (!globalSelectedUser) return;

            document.getElementById('printPeriodName').textContent = "CUENTA DE COBRO UNIFICADA";
            document.getElementById('printDate').textContent = new Date().toLocaleDateString();

            const u = globalSelectedUser;
            document.getElementById('printAgentName').textContent = u.full_name || u.username;
            document.getElementById('printAgentCC').textContent = u.account_holder_cc || u.username;
            document.getElementById('printAgentBank').textContent = `${u.bank || 'Banco No Reg.'} - ${u.account_type || ''} - ${u.account_number || 'N/A'}`;

            let total = 0;
            const tbody = document.getElementById('printDetailsBody');
            tbody.innerHTML = '';

            // GROUP BY PERIOD
            // 1. Group records
            const groups = {};
            globalRecordsCache.forEach(r => {
                const key = r.period_id;
                if (!groups[key]) groups[key] = { name: r.period_name, code: r.study_code, total: 0, items: [] };
                groups[key].items.push(r);
                groups[key].total += r.total_amount;
            });

            // 2. Render Groups
            // Sort by distinct periods if needed, currently cache order is DB order (created_at)

            Object.values(groups).forEach(g => {
                total += g.total;

                // HEADER ROW
                const headerTr = document.createElement('tr');
                headerTr.style.background = '#e2e8f0'; // Light gray for subheading
                headerTr.innerHTML = `
                   <td colspan="4" style="font-weight:bold; font-size: 0.95rem; text-transform:uppercase;">
                       ${g.name} ${g.code ? '- EST ' + g.code : ''}
                   </td>
                `;
                tbody.appendChild(headerTr);

                // DETAILS
                g.items.forEach(r => {
                    let details = [];
                    try { details = JSON.parse(r.details_json); } catch (e) { }

                    if (details.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                           <td style="padding-left:20px;">Pago General</td>
                           <td style="text-align:center;">-</td>
                           <td style="text-align:right;">-</td>
                           <td style="text-align:right;">$${r.total_amount.toLocaleString()}</td>
                         `;
                        tbody.appendChild(tr);
                    } else {
                        details.forEach(d => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                               <td style="padding-left:20px;">${d.concept}</td>
                               <td style="text-align:center;">${d.qty}</td>
                               <td style="text-align:right;">$${d.rate.toLocaleString()}</td>
                               <td style="text-align:right;">$${d.total.toLocaleString()}</td>
                           `;
                            tbody.appendChild(tr);
                        });
                    }
                });
            });

            document.getElementById('printTotal').textContent = '$' + total.toLocaleString();
            window.print();
        }

        function updateDefaultRates() {
            const type = document.getElementById('pType').value;
            if (type === 'ascensor') {
                document.getElementById('pRateCensus').value = 5000;
                document.getElementById('pRateEffective').value = 10000;
            } else if (type === 'in_home') {
                document.getElementById('pRateCensus').value = 5000;
                document.getElementById('pRateEffective').value = 10000;
            }
        }

        async function createLiquidacion() {
            const name = document.getElementById('pName').value;
            const code = document.getElementById('pCode').value;
            const type = document.getElementById('pType').value;
            const start = document.getElementById('pStartDate').value;
            const end = document.getElementById('pEndDate').value;
            const rCensus = document.getElementById('pRateCensus').value;
            const rEffective = document.getElementById('pRateEffective').value;

            if (!name || !start || !end) return alert("Por favor complete nombre y fechas.");

            const formData = new FormData();
            formData.append('name', name);
            formData.append('study_type', type);
            formData.append('study_code', code);
            formData.append('start_date', start);
            formData.append('end_date', end);
            formData.append('census_rate', rCensus);
            formData.append('effective_rate', rEffective);

            const res = await fetch('/payroll/periods', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            if (res.ok) {
                alert("Nómina Creada.");
                loadPeriods();
            } else {
                alert("Error al crear. Intente recargar la página.");
            }
        }

        async function loadPeriods() {
            const res = await fetch('/payroll/periods', { headers: { 'Authorization': 'Bearer ' + token } });
            const list = await res.json();
            const container = document.getElementById('periodsList');
            container.innerHTML = '';

            const isSuper = currentUser.role === 'superuser';

            list.forEach(p => {
                if (p.is_visible === false && !isSuper) return;

                const opacity = (p.is_visible !== false) ? '1' : '0.6';
                const start = p.start_date ? p.start_date.substring(0, 10) : (p.execution_date || '');
                const end = p.end_date ? p.end_date.substring(0, 10) : '';
                const stateLabel = (p.is_visible !== false) ? 'Activa' : 'Inactiva';
                const stateColor = (p.is_visible !== false) ? '#22c55e' : '#64748b';

                let actionsHtml = '';

                if (isSuper) {
                    if (p.is_visible !== false) {
                        actionsHtml += `<button onclick='toggleVisibility(${p.id})' style="background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px;">Desactivar</button>`;
                    } else {
                        actionsHtml += `<button onclick='toggleVisibility(${p.id})' style="background:#22c55e; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px;">Activar</button>`;
                    }
                }

                actionsHtml += `<button onclick='openDetails(${JSON.stringify(p)})' style="background:#3b82f6; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; margin-right:5px;"><i class="fas fa-users-cog"></i> Gestionar</button>`;

                if (isSuper) {
                    actionsHtml += `<button onclick='deletePeriod(${p.id})' style="background:#dc2626; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i></button>`;
                }

                const div = document.createElement('div');
                div.style.background = 'rgba(30, 41, 59, 0.5)';
                div.style.padding = '15px';
                div.style.marginBottom = '10px';
                div.style.borderRadius = '8px';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.borderLeft = `4px solid ${stateColor}`;
                div.style.opacity = opacity;

                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem; display:flex; align-items:center; gap:10px;">
                            ${p.name} 
                            <span style="font-size:0.8rem; background:#0f172a; padding:2px 6px; border-radius:4px;">${p.study_code || 'S/C'}</span>
                            <span style="font-size:0.75rem; background:${stateColor}; padding:2px 8px; border-radius:10px; color:white;">${stateLabel}</span>
                        </div>
                        <div style="color:#aaa; font-size:0.9rem; margin-top:4px;">
                            <i class="far fa-calendar-alt"></i> ${start} - ${end} | 
                            <span style="text-transform:uppercase; color:#93c5fd;">${p.study_type || 'General'}</span>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        ${actionsHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function deletePeriod(id) {
            if (!confirm("¿Estás seguro de eliminar esta Nómina? Se borrarán todos los registros asociados.")) return;
            try {
                const res = await fetch(`/payroll/periods/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    alert("Eliminado.");
                    loadPeriods();
                } else {
                    alert("Error al eliminar.");
                }
            } catch (e) { console.error(e); }
        }

        async function toggleVisibility(id) {
            const res = await fetch(`/payroll/periods/${id}/toggle-visibility`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) loadPeriods();
        }

        async function openDetails(period) {
            currentLiquidacionId = period.id;
            pRates = period.rates || { census: 0, effective: 0 };

            document.getElementById('listCard').style.display = 'none';
            document.getElementById('creationCard').style.display = 'none';
            document.getElementById('periodDetailsCard').style.display = 'block';

            document.getElementById('detailsTitle').textContent = period.name + (period.study_code ? ` (${period.study_code})` : '');
            document.getElementById('detailsSubtitle').textContent = `Tarifas: Censo $${pRates.census} | Efectiva $${pRates.effective}`;

            document.getElementById('displayRateCen').textContent = '$' + pRates.census.toLocaleString();
            document.getElementById('displayRateEff').textContent = '$' + pRates.effective.toLocaleString();

            loadRecords(period.id);
        }

        function closeDetails() {
            document.getElementById('periodDetailsCard').style.display = 'none';
            document.getElementById('listCard').style.display = 'block';
            document.getElementById('creationCard').style.display = 'block';
        }

        async function loadRecords(id) {
            const tbody = document.getElementById('periodDetailsBody');
            const tfoot = document.getElementById('periodDetailsFoot');
            tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
            tfoot.innerHTML = '';

            currentPeriodUserIds.clear();

            const res = await fetch(`/payroll/records/${id}`, { headers: { 'Authorization': 'Bearer ' + token } });
            const records = await res.json();
            tbody.innerHTML = '';

            records.forEach(r => currentPeriodUserIds.add(r.user_id));

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#aaa;">No hay personas agregadas a esta nómina.</td></tr>';
                return;
            }

            let sumEff = 0, sumCen = 0, sumTotal = 0;
            let qtyEff = 0, qtyCen = 0;

            records.forEach(r => {
                const user = window.allUsersMap[r.user_id] || { full_name: 'Unknown', username: r.user_id };

                const effTotal = r.total_effective * pRates.effective;
                const cenTotal = r.total_censuses * pRates.census;

                sumEff += effTotal;
                sumCen += cenTotal;
                sumTotal += r.total_amount;

                qtyEff += r.total_effective;
                qtyCen += r.total_censuses;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${user.full_name || user.username}</div>
                        <div style="font-size:0.8rem; color:#aaa;">CC: ${user.username}</div>
                    </td>
                    <td>
                        <div style="font-weight:bold;">${r.total_effective}</div>
                        <div style="font-size:0.75rem; color:#aaa;">x $${pRates.effective.toLocaleString()} = $${effTotal.toLocaleString()}</div>
                    </td>
                    <td>
                        <div style="font-weight:bold;">${r.total_censuses}</div>
                        <div style="font-size:0.75rem; color:#aaa;">x $${pRates.census.toLocaleString()} = $${cenTotal.toLocaleString()}</div>
                    </td>
                    <td style="color:#4ade80; font-weight:bold;">$${r.total_amount.toLocaleString()}</td>
                    <td>
                        <div style="display:flex; gap:10px;">
                            <!-- PRINT REMOVED PER REQUEST -->
                            <button onclick='editRecord(${JSON.stringify(r)})' class="btn-icon" title="Editar" style="color:#f59e0b;"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick='deleteRecordUser(${currentLiquidacionId}, ${r.user_id})' class="btn-icon" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            tfoot.innerHTML = `
                <tr style="font-weight:bold; font-size:1.1rem;">
                    <td style="text-align:right;">TOTALES:</td>
                    <td style="color:white;">
                        <span style="display:block; font-size:1.2rem; color:#cbd5e1;">${qtyEff}</span>
                        <span style="font-size:0.9rem; color:#94a3b8;">$${sumEff.toLocaleString()}</span>
                    </td>
                    <td style="color:white;">
                         <span style="display:block; font-size:1.2rem; color:#cbd5e1;">${qtyCen}</span>
                         <span style="font-size:0.9rem; color:#94a3b8;">$${sumCen.toLocaleString()}</span>
                    </td>
                    <td style="color:#4ade80; vertical-align:middle;">$${sumTotal.toLocaleString()}</td>
                    <td></td>
                </tr>
            `;
        }

        async function deleteRecordUser(periodId, userId) {
            if (!confirm("¿Eliminar este registro?")) return;
            const res = await fetch(`/payroll/records/${periodId}/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                loadRecords(periodId);
                if (currentPeriodUserIds.has(userId)) currentPeriodUserIds.delete(userId);
            } else {
                alert("Error al eliminar");
            }
        }

        function rebuildUserDropdown(excludeSet = null) {
            const sel = document.getElementById('manualUser');
            sel.innerHTML = '';
            const sortedUsers = Object.values(window.allUsersMap).sort((a, b) => (a.full_name || a.username).localeCompare(b.full_name || b.username));
            sortedUsers.forEach(u => {
                if (excludeSet && excludeSet.has(u.id)) return;
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = u.full_name || u.username;
                sel.appendChild(opt);
            });
        }

        function openManualModal() {
            if (!currentLiquidacionId) return;
            rebuildUserDropdown(currentPeriodUserIds);
            document.getElementById('manualModal').style.display = 'block';
            document.getElementById('manualUser').disabled = false;
            document.getElementById('manualEffective').value = 0;
            document.getElementById('manualCensus').value = 0;
        }

        function editRecord(r) {
            rebuildUserDropdown(null);
            document.getElementById('manualModal').style.display = 'block';
            document.getElementById('manualUser').value = r.user_id;
            document.getElementById('manualUser').disabled = true;
            document.getElementById('manualEffective').value = r.total_effective;
            document.getElementById('manualCensus').value = r.total_censuses;
        }

        function closeManualModal() {
            document.getElementById('manualModal').style.display = 'none';
        }

        async function saveManualRecord() {
            const userId = document.getElementById('manualUser').value;
            const eff = parseInt(document.getElementById('manualEffective').value) || 0;
            const cen = parseInt(document.getElementById('manualCensus').value) || 0;

            const body = {
                total_effective: eff,
                total_censuses: cen,
                total_enp: 0,
                total_training: 0
            };

            const res = await fetch(`/payroll/records/manual?period_id=${currentLiquidacionId}&user_id=${userId}`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                closeManualModal();
                loadRecords(currentLiquidacionId);
            } else {
                alert("Error al guardar");
            }
        }

        async function loadMyPayments() {
            const res = await fetch('/payroll/my-records', { headers: { 'Authorization': 'Bearer ' + token } });
            const list = await res.json();
            const container = document.getElementById('myPaymentsList');
            container.innerHTML = '';
            list.forEach(r => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                         <div>Nómina #${r.period_id}</div>
                         <div style="font-size:1.2rem; font-weight:bold; color:#4ade80;">$${r.total_amount.toLocaleString()}</div>
                         <button style="padding:5px 10px;">Ver Cuenta</button>
                    </div>
                 `;
                container.appendChild(div);
            });
        }

        init();
    </script>
</body>

</html>